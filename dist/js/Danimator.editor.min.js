/*! danimator v0.0.1 2017-06-27 */
function Snappables(a){var b=this;return b.list=[],b.tolerance=a,b.add=function(a){return _.isArray(a)||(a=[a]),b.list=_.union(b.list,a),b},b.remove=function(a){return b.list=_.pull(b.list,a),b},b.snap=function(a){var c=a;return b.list=b.list.sort(),_.each(b.list,function(d){if(Math.abs(d-a)<b.tolerance)return c=d,!1}),c},b}function Undoable(a,b,c,d){var e=this;e.undo=b,e.redo=a,undoHistory.index++,undoHistory.title=c||"last action";document.title;document.title=undoHistory.title,history.pushState({undoIndex:undoHistory.index},undoHistory.title);var f={undo:b,redo:a};return Undos.add(f),d||f.redo(),e}function _asGroup(a){return{content:a,type:"group"}}function _linearTolog(a,b,c){return b=Math.log(b),c=Math.log(c),Math.exp(b+(c-b)*a)}function _decimalPlaces(a){var b=(""+a).match(/(?:\.(\d+))?(?:[eE]([+-]?\d+))?$/);return b?Math.max(0,(b[1]?b[1].length:0)-(b[2]?+b[2]:0)):0}function _basename(a){var b=new String(a).substring(_.lastIndexOf(a,"/")+1);return-1!=_.lastIndexOf(b,".")&&(b=b.substring(0,_.lastIndexOf(b,"."))),b}function _basepath(a){return a.substring(0,_.lastIndexOf(a,"/")+1)}function _deepOmit(a,b){function c(a){return _.transform(a,function(a,b,e){e in d||(a[e]=_.isObject(b)?c(b):b)})}var d=_.keyBy(Array.isArray(b)?b:[b]);return c(a)}function _firstFromSet(a){return a.values().next().value}function _changesFile(a){_.set(currentGame.files[a],"saved",!1)}function _changesProp(a,b){var c=_PANELS.properties.$element.find('input[data-prop="'+a+'"]');"boolean"==typeof b?c.prop("checked",b):c.val(b)}function _getAnimationName(a,b,c){var d=c&&c.match(/^danimator(.*)$/);return d=d&&_.lowerFirst(d[1]),"then"===d&&(d=!1),b=b&&b.replace(/\./g,"_"),d=d||b?"_"+(d||b):"",(a.name||"layer"+a.id)+d}function _resetSelection(){selectedElements.unselect(currentGame.project),_anchorViz.visible=!1,_PANELS.layers.$element.find(".layer").removeClass("selected").end().find(".type").text("").end().find("ul.main").scrollTop(0).html(_PANELS.properties.emptyState.template({checked:FLAGS.view.selection}))}function alert(a,b){alertify&&alertify.notify(a,b||"success")}function slug(a){return a.replace(/[^a-z0-9_\-]+/g,"_")}function noop(a){return a}function setLoading(a,b){_loadingStates.indexOf(a)<0&&_loadingStates.push(a),_loadingStates.length&&$(b||"body").addClass("loading")}function resetLoading(a,b){_loadingStates.indexOf(a)>=0&&_.pull(_loadingStates,a),_loadingStates.length||$(b||"body").removeClass("loading")}function _createLayers(a,b){_.each(a,function(c,d){if(c){var e=Danimator.sceneElement(c),f=$(_PANELS.layers.template({name:c.name||"[Layer "+c.id+"]",hasChildren:!(!c.children||!c.children.length),hidden:!c.visible,id:c.id})).data("sceneElement",e);if(e.data.$layer=f,c.data.onStateChanged=c.data.onFrameChanged=function(){_createLayers(a,b.empty())},c.children&&c.children.length){var g=$("<ul>").appendTo(f);_createLayers(c.children,g)}b.append(f)}})}function _getStartTime(a){return _.get(a,"options.delay",0)}function _getEndTime(a){return _getStartTime(a)+_.get(a,"duration",0)}function _getStartStyle(a,b,c,d){var e=_.get(ANIMATABLE_PROPERTIES[d],a.replace(/(\.\d+)?\.([^\.]+)$/,".content.$2"));if(e){var f,g=b[c];if(_.isEqual(e.range,[0,1])){f=0===c?g.initValue:_.get(g,"from",b[c-1].to);var h=_.repeat(parseInt(15*f).toString(16),3)}else"hue"===_.last(a.split("."))&&(f=_.get(g,"from"),h=new paper.Color({hue:f,saturation:1,lightness:.5}).toCSS(!0).slice(1));return"background:#"+h}}function _getRangeStyle(a,b,c,d){var e=_.get(ANIMATABLE_PROPERTIES[d],a.replace(/(\.\d+)?\.([^\.]+)$/,".content.$2"));if(e){var f,g,h=b[c],i=b[c-1],j=h.to;if(h.from=0===c?h.initValue:_.isNil(h.from)?i.to:h.from,e.range&&_.isEqual(e.range,[0,1])?(f=_.repeat(parseInt(15*h.from).toString(16),3),g=_.repeat(parseInt(15*j).toString(16),3)):"hue"===_.last(a.split("."))&&(f=new paper.Color({hue:h.from,saturation:1,lightness:.5}).toCSS(!0).slice(1),g=new paper.Color({hue:j,saturation:1,lightness:.5}).toCSS(!0).slice(1)),f&&g)return"background:linear-gradient(90deg,#"+f+",#"+g+")"}}function _getEndStyle(a,b,c){var d=_.get(ANIMATABLE_PROPERTIES[c],a.replace(/(\.\d+)?\.([^\.]+)$/,".content.$2"));if(d){if(d.range&&_.isEqual(d.range,[0,1]))var e=_.repeat(parseInt(15*b.to).toString(16),3);else if("hue"===_.last(a.split(".")))var e=new paper.Color({hue:b.to,saturation:1,lightness:.5}).toCSS(!0).slice(1);return"background:#"+e}}function _createTracks(){var a=_PANELS.animations.$element.find("ul.main").empty();_.each(tracks,function(b){if(b){var c=_.mapValues(b.properties,_.partial(_.sortBy,_,"options.delay")),d=Danimator.sceneElement(b.item),e=$(_PANELS.animations.template({Danimator:Danimator,maxDuration:_.round(b.maxDuration,2),name:b.item.name,type:b.item.className,properties:c,TIME_FACTOR:TIME_FACTOR,getTrigger:function(a){switch(a.caller){case"":case"root":return""}return" triggered"}})).data({track:b,sceneElement:d,element:e});d.data.$keys=e;var f=a.append(e).find(".keyframe");_snapKeyframes.list=_.range(Danimator.maxDuration),f.each(function(){var a,b,c=$(this),d=c.top()-7,e=c.data("time"),f=c.prev(".range"),g=c.next(".range");_snapKeyframes.add(e),c.draggable({containment:[f.left()+1,d,g.right()-1,d],cursor:"pointer",start:function(){_frameDragging=!0},stop:function(c,d){_.each(b,function(b,c){_getStartTime(b)===e?(b.options.delay=a,b.duration=_getEndTime(b)-a):_getEndTime(b)===e&&(b.duration=a-_getStartTime(b))}),_frameDragging=!1,_createTracks()},drag:function(d,e){_frameDragging=!0;var f=e.position.left-1,g=(c.closest(".track").find(".keyframe").index(c),c.closest("li.timeline").data("property"));b=c.closest("li.item").data("track").properties[g],a=f/TIME_FACTOR,d.shiftKey&&(a=_snapKeyframes.snap(a),f=a*TIME_FACTOR,e.position.left=f+1),Danimator.time=a;var h=c.next(".range"),i=c.prev(".range"),j=c.next().next(".keyframe"),k={left:f};j.length&&(k.width=(j.data("time")-a)*TIME_FACTOR),i.width(f-i.position().left),h.css(k)}})})}})}function _createProperties(a,b,c,d,e){e=e?_.trim(e,".")+".":"",_.each(a,function(a,f){if("type"!==f){var g=1,h=[];switch(f){default:a.range&&(g=(a.range[1]-a.range[0])/100);break;case"frame":case"rotation":g=1}var i=e+f,j=tracks[c.id]&&_.get(tracks[c.id].properties,i);if(j){h.push("animated");var k=_.find(j,{options:{delay:Danimator.time}});k||(k=_.some(j,function(a){return _getEndTime(a)===Danimator.time})),k&&h.push("keyed"),_.reject(j,{caller:"root"}).length&&h.push("triggered")}var l=_.extend({},{name:f+"",item:c,path:e,keyed:h,range:["",""],step:g,type:a.type,value:_.get(d||c,f)},a);if("elements"===l.type){var m={};_.each(_.get(d||c,f),function(a,b){m[b]=ANIMATABLE_PROPERTIES[a.className]}),l.content=m,l.type="group"}if(a.allowedValues&&!a.allowedValues.length)if("object"==typeof l.value)l.content=_.mapValues(l.value,function(a,b){return ANIMATABLE_PROPERTIES[c.className][f]}),l.type="group";else if("state."===e){var n=Danimator.sceneElement(c).find(f)[0].item.states;l.allowedValues=Object.keys(n)}var o=$(_PANELS.properties.template(l)).data("track",_.first(j));if("group"===l.type){var p=$("<ul>").appendTo(o);_createProperties(l.content,p,c,_.get(c,f),i)}b.append(o)}})}function _createAudio(){var a=_PANELS.audio.$element.find("ul.main").empty(),b=!1;_.each(Danimator.sounds,function(c,d){var e={container:"#audio_"+slug(d),cursorColor:"crimson",fillParent:!1,loop:c.get("loop"),height:40,width:200,minPxPerSec:TIME_FACTOR,normalize:!0,progressColor:"crimson",waveColor:"white"},f=$(_PANELS.audio.template({name:d,id:"audio_"+slug(d)}));a.append(f),b=WaveSurfer.create(e);var g=b;b.on("ready",function(a){c.duration=b.getDuration()}),b.on("finish",function(a){g.seekTo(0),e.loop&&(Danimator.sounds[d].stopped||g.play())}),b.on("seek",function(a,b){_timeScrubbing||(Danimator.time=g.getCurrentTime())}),c.duration=0,c.wave=b,b.load("audio/"+d),f.data("wave",b)})}var saveAs=saveAs||function(a){"use strict";if(!(void 0===a||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var b=a.document,c=function(){return a.URL||a.webkitURL||a},d=b.createElementNS("http://www.w3.org/1999/xhtml","a"),e="download"in d,f=function(a){var b=new MouseEvent("click");a.dispatchEvent(b)},g=/constructor/i.test(a.HTMLElement)||a.safari,h=/CriOS\/[\d]+/.test(navigator.userAgent),i=function(b){(a.setImmediate||a.setTimeout)(function(){throw b},0)},j="application/octet-stream",k=4e4,l=function(a){var b=function(){"string"==typeof a?c().revokeObjectURL(a):a.remove()};setTimeout(b,k)},m=function(a,b,c){b=[].concat(b);for(var d=b.length;d--;){var e=a["on"+b[d]];if("function"==typeof e)try{e.call(a,c||a)}catch(a){i(a)}}},n=function(a){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(a.type)?new Blob([String.fromCharCode(65279),a],{type:a.type}):a},o=function(b,i,k){k||(b=n(b));var o,p=this,q=b.type,r=q===j,s=function(){m(p,"writestart progress write writeend".split(" "))},t=function(){if((h||r&&g)&&a.FileReader){var d=new FileReader;return d.onloadend=function(){var b=h?d.result:d.result.replace(/^data:[^;]*;/,"data:attachment/file;");a.open(b,"_blank")||(a.location.href=b),b=void 0,p.readyState=p.DONE,s()},d.readAsDataURL(b),void(p.readyState=p.INIT)}if(o||(o=c().createObjectURL(b)),r)a.location.href=o;else{a.open(o,"_blank")||(a.location.href=o)}p.readyState=p.DONE,s(),l(o)};if(p.readyState=p.INIT,e)return o=c().createObjectURL(b),void setTimeout(function(){d.href=o,d.download=i,f(d),s(),l(o),p.readyState=p.DONE});t()},p=o.prototype,q=function(a,b,c){return new o(a,b||a.name||"download",c)};return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(a,b,c){return b=b||a.name||"download",c||(a=n(a)),navigator.msSaveOrOpenBlob(a,b)}:(p.abort=function(){},p.readyState=p.INIT=0,p.WRITING=1,p.DONE=2,p.error=p.onwritestart=p.onprogress=p.onwrite=p.onabort=p.onerror=p.onwriteend=null,q)}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!==define.amd&&define("FileSaver.js",function(){return saveAs}),function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a(jQuery)}(function(a){a.ui=a.ui||{},a.ui.version="1.12.1";var b=0,c=Array.prototype.slice;a.cleanData=function(b){return function(c){var d,e,f;for(f=0;null!=(e=c[f]);f++)try{(d=a._data(e,"events"))&&d.remove&&a(e).triggerHandler("remove")}catch(a){}b(c)}}(a.cleanData),a.widget=function(b,c,d){var e,f,g,h={},i=b.split(".")[0];b=b.split(".")[1];var j=i+"-"+b;return d||(d=c,c=a.Widget),a.isArray(d)&&(d=a.extend.apply(null,[{}].concat(d))),a.expr[":"][j.toLowerCase()]=function(b){return!!a.data(b,j)},a[i]=a[i]||{},e=a[i][b],f=a[i][b]=function(a,b){return this._createWidget?void(arguments.length&&this._createWidget(a,b)):new f(a,b)},a.extend(f,e,{version:d.version,_proto:a.extend({},d),_childConstructors:[]}),g=new c,g.options=a.widget.extend({},g.options),a.each(d,function(b,d){return a.isFunction(d)?void(h[b]=function(){function a(){return c.prototype[b].apply(this,arguments)}function e(a){return c.prototype[b].apply(this,a)}return function(){var b,c=this._super,f=this._superApply;return this._super=a,this._superApply=e,b=d.apply(this,arguments),this._super=c,this._superApply=f,b}}()):void(h[b]=d)}),f.prototype=a.widget.extend(g,{widgetEventPrefix:e?g.widgetEventPrefix||b:b},h,{constructor:f,namespace:i,widgetName:b,widgetFullName:j}),e?(a.each(e._childConstructors,function(b,c){var d=c.prototype;a.widget(d.namespace+"."+d.widgetName,f,c._proto)}),delete e._childConstructors):c._childConstructors.push(f),a.widget.bridge(b,f),f},a.widget.extend=function(b){for(var d,e,f=c.call(arguments,1),g=0,h=f.length;h>g;g++)for(d in f[g])e=f[g][d],f[g].hasOwnProperty(d)&&void 0!==e&&(b[d]=a.isPlainObject(e)?a.isPlainObject(b[d])?a.widget.extend({},b[d],e):a.widget.extend({},e):e);return b},a.widget.bridge=function(b,d){var e=d.prototype.widgetFullName||b;a.fn[b]=function(f){var g="string"==typeof f,h=c.call(arguments,1),i=this;return g?this.length||"instance"!==f?this.each(function(){var c,d=a.data(this,e);return"instance"===f?(i=d,!1):d?a.isFunction(d[f])&&"_"!==f.charAt(0)?(c=d[f].apply(d,h),c!==d&&void 0!==c?(i=c&&c.jquery?i.pushStack(c.get()):c,!1):void 0):a.error("no such method '"+f+"' for "+b+" widget instance"):a.error("cannot call methods on "+b+" prior to initialization; attempted to call method '"+f+"'")}):i=void 0:(h.length&&(f=a.widget.extend.apply(null,[f].concat(h))),this.each(function(){var b=a.data(this,e);b?(b.option(f||{}),b._init&&b._init()):a.data(this,e,new d(f,this))})),i}},a.Widget=function(){},a.Widget._childConstructors=[],a.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",defaultElement:"<div>",options:{classes:{},disabled:!1,create:null},_createWidget:function(c,d){d=a(d||this.defaultElement||this)[0],this.element=a(d),this.uuid=b++,this.eventNamespace="."+this.widgetName+this.uuid,this.bindings=a(),this.hoverable=a(),this.focusable=a(),this.classesElementLookup={},d!==this&&(a.data(d,this.widgetFullName,this),this._on(!0,this.element,{remove:function(a){a.target===d&&this.destroy()}}),this.document=a(d.style?d.ownerDocument:d.document||d),this.window=a(this.document[0].defaultView||this.document[0].parentWindow)),this.options=a.widget.extend({},this.options,this._getCreateOptions(),c),this._create(),this.options.disabled&&this._setOptionDisabled(this.options.disabled),this._trigger("create",null,this._getCreateEventData()),this._init()},_getCreateOptions:function(){return{}},_getCreateEventData:a.noop,_create:a.noop,_init:a.noop,destroy:function(){var b=this;this._destroy(),a.each(this.classesElementLookup,function(a,c){b._removeClass(c,a)}),this.element.off(this.eventNamespace).removeData(this.widgetFullName),this.widget().off(this.eventNamespace).removeAttr("aria-disabled"),this.bindings.off(this.eventNamespace)},_destroy:a.noop,widget:function(){return this.element},option:function(b,c){var d,e,f,g=b;if(0===arguments.length)return a.widget.extend({},this.options);if("string"==typeof b)if(g={},d=b.split("."),b=d.shift(),d.length){for(e=g[b]=a.widget.extend({},this.options[b]),f=0;d.length-1>f;f++)e[d[f]]=e[d[f]]||{},e=e[d[f]];if(b=d.pop(),1===arguments.length)return void 0===e[b]?null:e[b];e[b]=c}else{if(1===arguments.length)return void 0===this.options[b]?null:this.options[b];g[b]=c}return this._setOptions(g),this},_setOptions:function(a){var b;for(b in a)this._setOption(b,a[b]);return this},_setOption:function(a,b){return"classes"===a&&this._setOptionClasses(b),this.options[a]=b,"disabled"===a&&this._setOptionDisabled(b),this},_setOptionClasses:function(b){var c,d,e;for(c in b)e=this.classesElementLookup[c],b[c]!==this.options.classes[c]&&e&&e.length&&(d=a(e.get()),this._removeClass(e,c),d.addClass(this._classes({element:d,keys:c,classes:b,add:!0})))},_setOptionDisabled:function(a){this._toggleClass(this.widget(),this.widgetFullName+"-disabled",null,!!a),a&&(this._removeClass(this.hoverable,null,"ui-state-hover"),this._removeClass(this.focusable,null,"ui-state-focus"))},enable:function(){return this._setOptions({disabled:!1})},disable:function(){return this._setOptions({disabled:!0})},_classes:function(b){function c(c,f){var g,h;for(h=0;c.length>h;h++)g=e.classesElementLookup[c[h]]||a(),g=a(b.add?a.unique(g.get().concat(b.element.get())):g.not(b.element).get()),e.classesElementLookup[c[h]]=g,d.push(c[h]),f&&b.classes[c[h]]&&d.push(b.classes[c[h]])}var d=[],e=this;return b=a.extend({element:this.element,classes:this.options.classes||{}},b),this._on(b.element,{remove:"_untrackClassesElement"}),b.keys&&c(b.keys.match(/\S+/g)||[],!0),b.extra&&c(b.extra.match(/\S+/g)||[]),d.join(" ")},_untrackClassesElement:function(b){var c=this;a.each(c.classesElementLookup,function(d,e){-1!==a.inArray(b.target,e)&&(c.classesElementLookup[d]=a(e.not(b.target).get()))})},_removeClass:function(a,b,c){return this._toggleClass(a,b,c,!1)},_addClass:function(a,b,c){return this._toggleClass(a,b,c,!0)},_toggleClass:function(a,b,c,d){d="boolean"==typeof d?d:c;var e="string"==typeof a||null===a,f={extra:e?b:c,keys:e?a:b,element:e?this.element:a,add:d};return f.element.toggleClass(this._classes(f),d),this},_on:function(b,c,d){var e,f=this;"boolean"!=typeof b&&(d=c,c=b,b=!1),d?(c=e=a(c),this.bindings=this.bindings.add(c)):(d=c,c=this.element,e=this.widget()),a.each(d,function(d,g){function h(){return b||!0!==f.options.disabled&&!a(this).hasClass("ui-state-disabled")?("string"==typeof g?f[g]:g).apply(f,arguments):void 0}"string"!=typeof g&&(h.guid=g.guid=g.guid||h.guid||a.guid++);var i=d.match(/^([\w:-]*)\s*(.*)$/),j=i[1]+f.eventNamespace,k=i[2];k?e.on(j,k,h):c.on(j,h)})},_off:function(b,c){c=(c||"").split(" ").join(this.eventNamespace+" ")+this.eventNamespace,b.off(c).off(c),this.bindings=a(this.bindings.not(b).get()),this.focusable=a(this.focusable.not(b).get()),this.hoverable=a(this.hoverable.not(b).get())},_delay:function(a,b){function c(){return("string"==typeof a?d[a]:a).apply(d,arguments)}var d=this;return setTimeout(c,b||0)},_hoverable:function(b){this.hoverable=this.hoverable.add(b),this._on(b,{mouseenter:function(b){this._addClass(a(b.currentTarget),null,"ui-state-hover")},mouseleave:function(b){this._removeClass(a(b.currentTarget),null,"ui-state-hover")}})},_focusable:function(b){this.focusable=this.focusable.add(b),this._on(b,{focusin:function(b){this._addClass(a(b.currentTarget),null,"ui-state-focus")},focusout:function(b){this._removeClass(a(b.currentTarget),null,"ui-state-focus")}})},_trigger:function(b,c,d){var e,f,g=this.options[b];if(d=d||{},c=a.Event(c),c.type=(b===this.widgetEventPrefix?b:this.widgetEventPrefix+b).toLowerCase(),c.target=this.element[0],f=c.originalEvent)for(e in f)e in c||(c[e]=f[e]);return this.element.trigger(c,d),!(a.isFunction(g)&&!1===g.apply(this.element[0],[c].concat(d))||c.isDefaultPrevented())}},a.each({show:"fadeIn",hide:"fadeOut"},function(b,c){a.Widget.prototype["_"+b]=function(d,e,f){"string"==typeof e&&(e={effect:e});var g,h=e?!0===e||"number"==typeof e?c:e.effect||c:b;e=e||{},"number"==typeof e&&(e={duration:e}),g=!a.isEmptyObject(e),e.complete=f,e.delay&&d.delay(e.delay),g&&a.effects&&a.effects.effect[h]?d[b](e):h!==b&&d[h]?d[h](e.duration,e.easing,f):d.queue(function(c){a(this)[b](),f&&f.call(d[0]),c()})}}),a.widget,a.extend(a.expr[":"],{data:a.expr.createPseudo?a.expr.createPseudo(function(b){return function(c){return!!a.data(c,b)}}):function(b,c,d){return!!a.data(b,d[3])}}),a.fn.scrollParent=function(b){var c=this.css("position"),d="absolute"===c,e=b?/(auto|scroll|hidden)/:/(auto|scroll)/,f=this.parents().filter(function(){var b=a(this);return(!d||"static"!==b.css("position"))&&e.test(b.css("overflow")+b.css("overflow-y")+b.css("overflow-x"))}).eq(0);return"fixed"!==c&&f.length?f:a(this[0].ownerDocument||document)},a.ui.ie=!!/msie [\w.]+/.exec(navigator.userAgent.toLowerCase());var d=!1;a(document).on("mouseup",function(){d=!1}),a.widget("ui.mouse",{version:"1.12.1",options:{cancel:"input, textarea, button, select, option",distance:1,delay:0},_mouseInit:function(){var b=this;this.element.on("mousedown."+this.widgetName,function(a){return b._mouseDown(a)}).on("click."+this.widgetName,function(c){return!0===a.data(c.target,b.widgetName+".preventClickEvent")?(a.removeData(c.target,b.widgetName+".preventClickEvent"),c.stopImmediatePropagation(),!1):void 0}),this.started=!1},_mouseDestroy:function(){this.element.off("."+this.widgetName),this._mouseMoveDelegate&&this.document.off("mousemove."+this.widgetName,this._mouseMoveDelegate).off("mouseup."+this.widgetName,this._mouseUpDelegate)},_mouseDown:function(b){if(!d){this._mouseMoved=!1,this._mouseStarted&&this._mouseUp(b),this._mouseDownEvent=b;var c=this,e=1===b.which,f=!("string"!=typeof this.options.cancel||!b.target.nodeName)&&a(b.target).closest(this.options.cancel).length;return!(e&&!f&&this._mouseCapture(b))||(this.mouseDelayMet=!this.options.delay,this.mouseDelayMet||(this._mouseDelayTimer=setTimeout(function(){c.mouseDelayMet=!0},this.options.delay)),this._mouseDistanceMet(b)&&this._mouseDelayMet(b)&&(this._mouseStarted=!1!==this._mouseStart(b),!this._mouseStarted)?(b.preventDefault(),!0):(!0===a.data(b.target,this.widgetName+".preventClickEvent")&&a.removeData(b.target,this.widgetName+".preventClickEvent"),this._mouseMoveDelegate=function(a){return c._mouseMove(a)},this._mouseUpDelegate=function(a){return c._mouseUp(a)},this.document.on("mousemove."+this.widgetName,this._mouseMoveDelegate).on("mouseup."+this.widgetName,this._mouseUpDelegate),b.preventDefault(),d=!0,!0))}},_mouseMove:function(b){if(this._mouseMoved){if(a.ui.ie&&(!document.documentMode||9>document.documentMode)&&!b.button)return this._mouseUp(b);if(!b.which)if(b.originalEvent.altKey||b.originalEvent.ctrlKey||b.originalEvent.metaKey||b.originalEvent.shiftKey)this.ignoreMissingWhich=!0;else if(!this.ignoreMissingWhich)return this._mouseUp(b)}return(b.which||b.button)&&(this._mouseMoved=!0),this._mouseStarted?(this._mouseDrag(b),b.preventDefault()):(this._mouseDistanceMet(b)&&this._mouseDelayMet(b)&&(this._mouseStarted=!1!==this._mouseStart(this._mouseDownEvent,b),this._mouseStarted?this._mouseDrag(b):this._mouseUp(b)),!this._mouseStarted)},_mouseUp:function(b){this.document.off("mousemove."+this.widgetName,this._mouseMoveDelegate).off("mouseup."+this.widgetName,this._mouseUpDelegate),this._mouseStarted&&(this._mouseStarted=!1,b.target===this._mouseDownEvent.target&&a.data(b.target,this.widgetName+".preventClickEvent",!0),this._mouseStop(b)),this._mouseDelayTimer&&(clearTimeout(this._mouseDelayTimer),delete this._mouseDelayTimer),this.ignoreMissingWhich=!1,d=!1,b.preventDefault()},_mouseDistanceMet:function(a){return Math.max(Math.abs(this._mouseDownEvent.pageX-a.pageX),Math.abs(this._mouseDownEvent.pageY-a.pageY))>=this.options.distance},_mouseDelayMet:function(){return this.mouseDelayMet},_mouseStart:function(){},_mouseDrag:function(){},_mouseStop:function(){},_mouseCapture:function(){return!0}}),a.ui.plugin={add:function(b,c,d){var e,f=a.ui[b].prototype;for(e in d)f.plugins[e]=f.plugins[e]||[],f.plugins[e].push([c,d[e]])},call:function(a,b,c,d){var e,f=a.plugins[b];if(f&&(d||a.element[0].parentNode&&11!==a.element[0].parentNode.nodeType))for(e=0;f.length>e;e++)a.options[f[e][0]]&&f[e][1].apply(a.element,c)}},a.ui.safeActiveElement=function(a){var b;try{b=a.activeElement}catch(c){b=a.body}return b||(b=a.body),b.nodeName||(b=a.body),b},a.ui.safeBlur=function(b){b&&"body"!==b.nodeName.toLowerCase()&&a(b).trigger("blur")},a.widget("ui.draggable",a.ui.mouse,{version:"1.12.1",widgetEventPrefix:"drag",options:{addClasses:!0,appendTo:"parent",axis:!1,connectToSortable:!1,containment:!1,cursor:"auto",cursorAt:!1,grid:!1,handle:!1,helper:"original",iframeFix:!1,opacity:!1,refreshPositions:!1,revert:!1,revertDuration:500,scope:"default",scroll:!0,scrollSensitivity:20,scrollSpeed:20,snap:!1,snapMode:"both",snapTolerance:20,stack:!1,zIndex:!1,drag:null,start:null,stop:null},_create:function(){"original"===this.options.helper&&this._setPositionRelative(),this.options.addClasses&&this._addClass("ui-draggable"),this._setHandleClassName(),this._mouseInit()},_setOption:function(a,b){this._super(a,b),"handle"===a&&(this._removeHandleClassName(),this._setHandleClassName())},_destroy:function(){return(this.helper||this.element).is(".ui-draggable-dragging")?void(this.destroyOnClear=!0):(this._removeHandleClassName(),void this._mouseDestroy())},_mouseCapture:function(b){var c=this.options;return!(this.helper||c.disabled||a(b.target).closest(".ui-resizable-handle").length>0)&&(this.handle=this._getHandle(b),!!this.handle&&(this._blurActiveElement(b),this._blockFrames(!0===c.iframeFix?"iframe":c.iframeFix),!0))},_blockFrames:function(b){this.iframeBlocks=this.document.find(b).map(function(){var b=a(this);return a("<div>").css("position","absolute").appendTo(b.parent()).outerWidth(b.outerWidth()).outerHeight(b.outerHeight()).offset(b.offset())[0]})},_unblockFrames:function(){this.iframeBlocks&&(this.iframeBlocks.remove(),delete this.iframeBlocks)},_blurActiveElement:function(b){var c=a.ui.safeActiveElement(this.document[0]);a(b.target).closest(c).length||a.ui.safeBlur(c)},_mouseStart:function(b){var c=this.options;return this.helper=this._createHelper(b),this._addClass(this.helper,"ui-draggable-dragging"),this._cacheHelperProportions(),a.ui.ddmanager&&(a.ui.ddmanager.current=this),this._cacheMargins(),this.cssPosition=this.helper.css("position"),this.scrollParent=this.helper.scrollParent(!0),this.offsetParent=this.helper.offsetParent(),this.hasFixedAncestor=this.helper.parents().filter(function(){return"fixed"===a(this).css("position")}).length>0,this.positionAbs=this.element.offset(),this._refreshOffsets(b),this.originalPosition=this.position=this._generatePosition(b,!1),this.originalPageX=b.pageX,this.originalPageY=b.pageY,c.cursorAt&&this._adjustOffsetFromHelper(c.cursorAt),this._setContainment(),!1===this._trigger("start",b)?(this._clear(),!1):(this._cacheHelperProportions(),a.ui.ddmanager&&!c.dropBehaviour&&a.ui.ddmanager.prepareOffsets(this,b),this._mouseDrag(b,!0),a.ui.ddmanager&&a.ui.ddmanager.dragStart(this,b),!0)},_refreshOffsets:function(a){this.offset={top:this.positionAbs.top-this.margins.top,left:this.positionAbs.left-this.margins.left,scroll:!1,parent:this._getParentOffset(),relative:this._getRelativeOffset()},this.offset.click={left:a.pageX-this.offset.left,top:a.pageY-this.offset.top}},_mouseDrag:function(b,c){if(this.hasFixedAncestor&&(this.offset.parent=this._getParentOffset()),this.position=this._generatePosition(b,!0),this.positionAbs=this._convertPositionTo("absolute"),!c){var d=this._uiHash();if(!1===this._trigger("drag",b,d))return this._mouseUp(new a.Event("mouseup",b)),!1;this.position=d.position}return this.helper[0].style.left=this.position.left+"px",this.helper[0].style.top=this.position.top+"px",a.ui.ddmanager&&a.ui.ddmanager.drag(this,b),!1},_mouseStop:function(b){var c=this,d=!1;return a.ui.ddmanager&&!this.options.dropBehaviour&&(d=a.ui.ddmanager.drop(this,b)),this.dropped&&(d=this.dropped,this.dropped=!1),"invalid"===this.options.revert&&!d||"valid"===this.options.revert&&d||!0===this.options.revert||a.isFunction(this.options.revert)&&this.options.revert.call(this.element,d)?a(this.helper).animate(this.originalPosition,parseInt(this.options.revertDuration,10),function(){!1!==c._trigger("stop",b)&&c._clear()}):!1!==this._trigger("stop",b)&&this._clear(),!1},_mouseUp:function(b){return this._unblockFrames(),a.ui.ddmanager&&a.ui.ddmanager.dragStop(this,b),this.handleElement.is(b.target)&&this.element.trigger("focus"),a.ui.mouse.prototype._mouseUp.call(this,b)},cancel:function(){return this.helper.is(".ui-draggable-dragging")?this._mouseUp(new a.Event("mouseup",{target:this.element[0]})):this._clear(),this},_getHandle:function(b){return!this.options.handle||!!a(b.target).closest(this.element.find(this.options.handle)).length},_setHandleClassName:function(){this.handleElement=this.options.handle?this.element.find(this.options.handle):this.element,this._addClass(this.handleElement,"ui-draggable-handle")},_removeHandleClassName:function(){this._removeClass(this.handleElement,"ui-draggable-handle")},_createHelper:function(b){var c=this.options,d=a.isFunction(c.helper),e=d?a(c.helper.apply(this.element[0],[b])):"clone"===c.helper?this.element.clone().removeAttr("id"):this.element;return e.parents("body").length||e.appendTo("parent"===c.appendTo?this.element[0].parentNode:c.appendTo),d&&e[0]===this.element[0]&&this._setPositionRelative(),e[0]===this.element[0]||/(fixed|absolute)/.test(e.css("position"))||e.css("position","absolute"),e},_setPositionRelative:function(){/^(?:r|a|f)/.test(this.element.css("position"))||(this.element[0].style.position="relative")},_adjustOffsetFromHelper:function(b){"string"==typeof b&&(b=b.split(" ")),a.isArray(b)&&(b={left:+b[0],top:+b[1]||0}),"left"in b&&(this.offset.click.left=b.left+this.margins.left),"right"in b&&(this.offset.click.left=this.helperProportions.width-b.right+this.margins.left),"top"in b&&(this.offset.click.top=b.top+this.margins.top),"bottom"in b&&(this.offset.click.top=this.helperProportions.height-b.bottom+this.margins.top)},_isRootNode:function(a){return/(html|body)/i.test(a.tagName)||a===this.document[0]},_getParentOffset:function(){var b=this.offsetParent.offset(),c=this.document[0];return"absolute"===this.cssPosition&&this.scrollParent[0]!==c&&a.contains(this.scrollParent[0],this.offsetParent[0])&&(b.left+=this.scrollParent.scrollLeft(),b.top+=this.scrollParent.scrollTop()),this._isRootNode(this.offsetParent[0])&&(b={top:0,left:0}),{top:b.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:b.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if("relative"!==this.cssPosition)return{top:0,left:0};var a=this.element.position(),b=this._isRootNode(this.scrollParent[0]);return{top:a.top-(parseInt(this.helper.css("top"),10)||0)+(b?0:this.scrollParent.scrollTop()),left:a.left-(parseInt(this.helper.css("left"),10)||0)+(b?0:this.scrollParent.scrollLeft())}},_cacheMargins:function(){this.margins={left:parseInt(this.element.css("marginLeft"),10)||0,top:parseInt(this.element.css("marginTop"),10)||0,right:parseInt(this.element.css("marginRight"),10)||0,bottom:parseInt(this.element.css("marginBottom"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var b,c,d,e=this.options,f=this.document[0];return this.relativeContainer=null,e.containment?"window"===e.containment?void(this.containment=[a(window).scrollLeft()-this.offset.relative.left-this.offset.parent.left,a(window).scrollTop()-this.offset.relative.top-this.offset.parent.top,a(window).scrollLeft()+a(window).width()-this.helperProportions.width-this.margins.left,a(window).scrollTop()+(a(window).height()||f.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]):"document"===e.containment?void(this.containment=[0,0,a(f).width()-this.helperProportions.width-this.margins.left,(a(f).height()||f.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]):e.containment.constructor===Array?void(this.containment=e.containment):("parent"===e.containment&&(e.containment=this.helper[0].parentNode),c=a(e.containment),void((d=c[0])&&(b=/(scroll|auto)/.test(c.css("overflow")),this.containment=[(parseInt(c.css("borderLeftWidth"),10)||0)+(parseInt(c.css("paddingLeft"),10)||0),(parseInt(c.css("borderTopWidth"),10)||0)+(parseInt(c.css("paddingTop"),10)||0),(b?Math.max(d.scrollWidth,d.offsetWidth):d.offsetWidth)-(parseInt(c.css("borderRightWidth"),10)||0)-(parseInt(c.css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left-this.margins.right,(b?Math.max(d.scrollHeight,d.offsetHeight):d.offsetHeight)-(parseInt(c.css("borderBottomWidth"),10)||0)-(parseInt(c.css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top-this.margins.bottom],this.relativeContainer=c))):void(this.containment=null)},_convertPositionTo:function(a,b){b||(b=this.position);var c="absolute"===a?1:-1,d=this._isRootNode(this.scrollParent[0]);return{top:b.top+this.offset.relative.top*c+this.offset.parent.top*c-("fixed"===this.cssPosition?-this.offset.scroll.top:d?0:this.offset.scroll.top)*c,left:b.left+this.offset.relative.left*c+this.offset.parent.left*c-("fixed"===this.cssPosition?-this.offset.scroll.left:d?0:this.offset.scroll.left)*c}},_generatePosition:function(a,b){var c,d,e,f,g=this.options,h=this._isRootNode(this.scrollParent[0]),i=a.pageX,j=a.pageY;return h&&this.offset.scroll||(this.offset.scroll={top:this.scrollParent.scrollTop(),left:this.scrollParent.scrollLeft()}),b&&(this.containment&&(this.relativeContainer?(d=this.relativeContainer.offset(),c=[this.containment[0]+d.left,this.containment[1]+d.top,this.containment[2]+d.left,this.containment[3]+d.top]):c=this.containment,a.pageX-this.offset.click.left<c[0]&&(i=c[0]+this.offset.click.left),
a.pageY-this.offset.click.top<c[1]&&(j=c[1]+this.offset.click.top),a.pageX-this.offset.click.left>c[2]&&(i=c[2]+this.offset.click.left),a.pageY-this.offset.click.top>c[3]&&(j=c[3]+this.offset.click.top)),g.grid&&(e=g.grid[1]?this.originalPageY+Math.round((j-this.originalPageY)/g.grid[1])*g.grid[1]:this.originalPageY,j=c?e-this.offset.click.top>=c[1]||e-this.offset.click.top>c[3]?e:e-this.offset.click.top>=c[1]?e-g.grid[1]:e+g.grid[1]:e,f=g.grid[0]?this.originalPageX+Math.round((i-this.originalPageX)/g.grid[0])*g.grid[0]:this.originalPageX,i=c?f-this.offset.click.left>=c[0]||f-this.offset.click.left>c[2]?f:f-this.offset.click.left>=c[0]?f-g.grid[0]:f+g.grid[0]:f),"y"===g.axis&&(i=this.originalPageX),"x"===g.axis&&(j=this.originalPageY)),{top:j-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"===this.cssPosition?-this.offset.scroll.top:h?0:this.offset.scroll.top),left:i-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"===this.cssPosition?-this.offset.scroll.left:h?0:this.offset.scroll.left)}},_clear:function(){this._removeClass(this.helper,"ui-draggable-dragging"),this.helper[0]===this.element[0]||this.cancelHelperRemoval||this.helper.remove(),this.helper=null,this.cancelHelperRemoval=!1,this.destroyOnClear&&this.destroy()},_trigger:function(b,c,d){return d=d||this._uiHash(),a.ui.plugin.call(this,b,[c,d,this],!0),/^(drag|start|stop)/.test(b)&&(this.positionAbs=this._convertPositionTo("absolute"),d.offset=this.positionAbs),a.Widget.prototype._trigger.call(this,b,c,d)},plugins:{},_uiHash:function(){return{helper:this.helper,position:this.position,originalPosition:this.originalPosition,offset:this.positionAbs}}}),a.ui.plugin.add("draggable","connectToSortable",{start:function(b,c,d){var e=a.extend({},c,{item:d.element});d.sortables=[],a(d.options.connectToSortable).each(function(){var c=a(this).sortable("instance");c&&!c.options.disabled&&(d.sortables.push(c),c.refreshPositions(),c._trigger("activate",b,e))})},stop:function(b,c,d){var e=a.extend({},c,{item:d.element});d.cancelHelperRemoval=!1,a.each(d.sortables,function(){var a=this;a.isOver?(a.isOver=0,d.cancelHelperRemoval=!0,a.cancelHelperRemoval=!1,a._storedCSS={position:a.placeholder.css("position"),top:a.placeholder.css("top"),left:a.placeholder.css("left")},a._mouseStop(b),a.options.helper=a.options._helper):(a.cancelHelperRemoval=!0,a._trigger("deactivate",b,e))})},drag:function(b,c,d){a.each(d.sortables,function(){var e=!1,f=this;f.positionAbs=d.positionAbs,f.helperProportions=d.helperProportions,f.offset.click=d.offset.click,f._intersectsWith(f.containerCache)&&(e=!0,a.each(d.sortables,function(){return this.positionAbs=d.positionAbs,this.helperProportions=d.helperProportions,this.offset.click=d.offset.click,this!==f&&this._intersectsWith(this.containerCache)&&a.contains(f.element[0],this.element[0])&&(e=!1),e})),e?(f.isOver||(f.isOver=1,d._parent=c.helper.parent(),f.currentItem=c.helper.appendTo(f.element).data("ui-sortable-item",!0),f.options._helper=f.options.helper,f.options.helper=function(){return c.helper[0]},b.target=f.currentItem[0],f._mouseCapture(b,!0),f._mouseStart(b,!0,!0),f.offset.click.top=d.offset.click.top,f.offset.click.left=d.offset.click.left,f.offset.parent.left-=d.offset.parent.left-f.offset.parent.left,f.offset.parent.top-=d.offset.parent.top-f.offset.parent.top,d._trigger("toSortable",b),d.dropped=f.element,a.each(d.sortables,function(){this.refreshPositions()}),d.currentItem=d.element,f.fromOutside=d),f.currentItem&&(f._mouseDrag(b),c.position=f.position)):f.isOver&&(f.isOver=0,f.cancelHelperRemoval=!0,f.options._revert=f.options.revert,f.options.revert=!1,f._trigger("out",b,f._uiHash(f)),f._mouseStop(b,!0),f.options.revert=f.options._revert,f.options.helper=f.options._helper,f.placeholder&&f.placeholder.remove(),c.helper.appendTo(d._parent),d._refreshOffsets(b),c.position=d._generatePosition(b,!0),d._trigger("fromSortable",b),d.dropped=!1,a.each(d.sortables,function(){this.refreshPositions()}))})}}),a.ui.plugin.add("draggable","cursor",{start:function(b,c,d){var e=a("body"),f=d.options;e.css("cursor")&&(f._cursor=e.css("cursor")),e.css("cursor",f.cursor)},stop:function(b,c,d){var e=d.options;e._cursor&&a("body").css("cursor",e._cursor)}}),a.ui.plugin.add("draggable","opacity",{start:function(b,c,d){var e=a(c.helper),f=d.options;e.css("opacity")&&(f._opacity=e.css("opacity")),e.css("opacity",f.opacity)},stop:function(b,c,d){var e=d.options;e._opacity&&a(c.helper).css("opacity",e._opacity)}}),a.ui.plugin.add("draggable","scroll",{start:function(a,b,c){c.scrollParentNotHidden||(c.scrollParentNotHidden=c.helper.scrollParent(!1)),c.scrollParentNotHidden[0]!==c.document[0]&&"HTML"!==c.scrollParentNotHidden[0].tagName&&(c.overflowOffset=c.scrollParentNotHidden.offset())},drag:function(b,c,d){var e=d.options,f=!1,g=d.scrollParentNotHidden[0],h=d.document[0];g!==h&&"HTML"!==g.tagName?(e.axis&&"x"===e.axis||(d.overflowOffset.top+g.offsetHeight-b.pageY<e.scrollSensitivity?g.scrollTop=f=g.scrollTop+e.scrollSpeed:b.pageY-d.overflowOffset.top<e.scrollSensitivity&&(g.scrollTop=f=g.scrollTop-e.scrollSpeed)),e.axis&&"y"===e.axis||(d.overflowOffset.left+g.offsetWidth-b.pageX<e.scrollSensitivity?g.scrollLeft=f=g.scrollLeft+e.scrollSpeed:b.pageX-d.overflowOffset.left<e.scrollSensitivity&&(g.scrollLeft=f=g.scrollLeft-e.scrollSpeed))):(e.axis&&"x"===e.axis||(b.pageY-a(h).scrollTop()<e.scrollSensitivity?f=a(h).scrollTop(a(h).scrollTop()-e.scrollSpeed):a(window).height()-(b.pageY-a(h).scrollTop())<e.scrollSensitivity&&(f=a(h).scrollTop(a(h).scrollTop()+e.scrollSpeed))),e.axis&&"y"===e.axis||(b.pageX-a(h).scrollLeft()<e.scrollSensitivity?f=a(h).scrollLeft(a(h).scrollLeft()-e.scrollSpeed):a(window).width()-(b.pageX-a(h).scrollLeft())<e.scrollSensitivity&&(f=a(h).scrollLeft(a(h).scrollLeft()+e.scrollSpeed)))),!1!==f&&a.ui.ddmanager&&!e.dropBehaviour&&a.ui.ddmanager.prepareOffsets(d,b)}}),a.ui.plugin.add("draggable","snap",{start:function(b,c,d){var e=d.options;d.snapElements=[],a(e.snap.constructor!==String?e.snap.items||":data(ui-draggable)":e.snap).each(function(){var b=a(this),c=b.offset();this!==d.element[0]&&d.snapElements.push({item:this,width:b.outerWidth(),height:b.outerHeight(),top:c.top,left:c.left})})},drag:function(b,c,d){var e,f,g,h,i,j,k,l,m,n,o=d.options,p=o.snapTolerance,q=c.offset.left,r=q+d.helperProportions.width,s=c.offset.top,t=s+d.helperProportions.height;for(m=d.snapElements.length-1;m>=0;m--)i=d.snapElements[m].left-d.margins.left,j=i+d.snapElements[m].width,k=d.snapElements[m].top-d.margins.top,l=k+d.snapElements[m].height,i-p>r||q>j+p||k-p>t||s>l+p||!a.contains(d.snapElements[m].item.ownerDocument,d.snapElements[m].item)?(d.snapElements[m].snapping&&d.options.snap.release&&d.options.snap.release.call(d.element,b,a.extend(d._uiHash(),{snapItem:d.snapElements[m].item})),d.snapElements[m].snapping=!1):("inner"!==o.snapMode&&(e=p>=Math.abs(k-t),f=p>=Math.abs(l-s),g=p>=Math.abs(i-r),h=p>=Math.abs(j-q),e&&(c.position.top=d._convertPositionTo("relative",{top:k-d.helperProportions.height,left:0}).top),f&&(c.position.top=d._convertPositionTo("relative",{top:l,left:0}).top),g&&(c.position.left=d._convertPositionTo("relative",{top:0,left:i-d.helperProportions.width}).left),h&&(c.position.left=d._convertPositionTo("relative",{top:0,left:j}).left)),n=e||f||g||h,"outer"!==o.snapMode&&(e=p>=Math.abs(k-s),f=p>=Math.abs(l-t),g=p>=Math.abs(i-q),h=p>=Math.abs(j-r),e&&(c.position.top=d._convertPositionTo("relative",{top:k,left:0}).top),f&&(c.position.top=d._convertPositionTo("relative",{top:l-d.helperProportions.height,left:0}).top),g&&(c.position.left=d._convertPositionTo("relative",{top:0,left:i}).left),h&&(c.position.left=d._convertPositionTo("relative",{top:0,left:j-d.helperProportions.width}).left)),!d.snapElements[m].snapping&&(e||f||g||h||n)&&d.options.snap.snap&&d.options.snap.snap.call(d.element,b,a.extend(d._uiHash(),{snapItem:d.snapElements[m].item})),d.snapElements[m].snapping=e||f||g||h||n)}}),a.ui.plugin.add("draggable","stack",{start:function(b,c,d){var e,f=d.options,g=a.makeArray(a(f.stack)).sort(function(b,c){return(parseInt(a(b).css("zIndex"),10)||0)-(parseInt(a(c).css("zIndex"),10)||0)});g.length&&(e=parseInt(a(g[0]).css("zIndex"),10)||0,a(g).each(function(b){a(this).css("zIndex",e+b)}),this.css("zIndex",e+g.length))}}),a.ui.plugin.add("draggable","zIndex",{start:function(b,c,d){var e=a(c.helper),f=d.options;e.css("zIndex")&&(f._zIndex=e.css("zIndex")),e.css("zIndex",f.zIndex)},stop:function(b,c,d){var e=d.options;e._zIndex&&a(c.helper).css("zIndex",e._zIndex)}}),a.ui.draggable}),function(a,b){"function"==typeof define&&define.amd?define("wavesurfer",[],function(){return a.WaveSurfer=b()}):"object"==typeof exports?module.exports=b():a.WaveSurfer=b()}(this,function(){"use strict";var a={defaultParams:{audioContext:null,audioRate:1,autoCenter:!0,backend:"WebAudio",barHeight:1,closeAudioContext:!1,container:null,cursorColor:"#333",cursorWidth:1,dragSelection:!0,fillParent:!0,forceDecode:!1,height:128,hideScrollbar:!1,interact:!0,loopSelection:!0,mediaContainer:null,mediaControls:!1,mediaType:"audio",minPxPerSec:20,partialRender:!1,pixelRatio:window.devicePixelRatio||screen.deviceXDPI/screen.logicalXDPI,progressColor:"#555",normalize:!1,renderer:"MultiCanvas",scrollParent:!1,skipLength:2,splitChannels:!1,waveColor:"#999"},init:function(b){if(this.params=a.util.extend({},this.defaultParams,b),this.container="string"==typeof b.container?document.querySelector(this.params.container):this.params.container,!this.container)throw new Error("Container element not found");if(null==this.params.mediaContainer?this.mediaContainer=this.container:"string"==typeof this.params.mediaContainer?this.mediaContainer=document.querySelector(this.params.mediaContainer):this.mediaContainer=this.params.mediaContainer,!this.mediaContainer)throw new Error("Media Container element not found");this.savedVolume=0,this.isMuted=!1,this.tmpEvents=[],this.currentAjax=null,this.createDrawer(),this.createBackend(),this.createPeakCache(),this.isDestroyed=!1},createDrawer:function(){var b=this;this.drawer=Object.create(a.Drawer[this.params.renderer]),this.drawer.init(this.container,this.params),this.drawer.on("redraw",function(){b.drawBuffer(),b.drawer.progress(b.backend.getPlayedPercents())}),this.drawer.on("click",function(a,c){setTimeout(function(){b.seekTo(c)},0)}),this.drawer.on("scroll",function(a){b.params.partialRender&&b.drawBuffer(),b.fireEvent("scroll",a)})},createBackend:function(){var b=this;this.backend&&this.backend.destroy(),"AudioElement"==this.params.backend&&(this.params.backend="MediaElement"),"WebAudio"!=this.params.backend||a.WebAudio.supportsWebAudio()||(this.params.backend="MediaElement"),this.backend=Object.create(a[this.params.backend]),this.backend.init(this.params),this.backend.on("finish",function(){b.fireEvent("finish")}),this.backend.on("play",function(){b.fireEvent("play")}),this.backend.on("pause",function(){b.fireEvent("pause")}),this.backend.on("audioprocess",function(a){b.drawer.progress(b.backend.getPlayedPercents()),b.fireEvent("audioprocess",a)})},createPeakCache:function(){this.params.partialRender&&(this.peakCache=Object.create(a.PeakCache),this.peakCache.init())},getDuration:function(){return this.backend.getDuration()},getCurrentTime:function(){return this.backend.getCurrentTime()},play:function(a,b){this.fireEvent("interaction",this.play.bind(this,a,b)),this.backend.play(a,b)},pause:function(){this.backend.isPaused()||this.backend.pause()},playPause:function(){this.backend.isPaused()?this.play():this.pause()},isPlaying:function(){return!this.backend.isPaused()},skipBackward:function(a){this.skip(-a||-this.params.skipLength)},skipForward:function(a){this.skip(a||this.params.skipLength)},skip:function(a){var b=this.getCurrentTime()||0,c=this.getDuration()||1;b=Math.max(0,Math.min(c,b+(a||0))),this.seekAndCenter(b/c)},seekAndCenter:function(a){this.seekTo(a),this.drawer.recenter(a)},seekTo:function(a){this.fireEvent("interaction",this.seekTo.bind(this,a));var b=this.backend.isPaused();b||this.backend.pause();var c=this.params.scrollParent;this.params.scrollParent=!1,this.backend.seekTo(a*this.getDuration()),this.drawer.progress(this.backend.getPlayedPercents()),b||this.backend.play(),this.params.scrollParent=c,this.fireEvent("seek",a)},stop:function(){this.pause(),this.seekTo(0),this.drawer.progress(0)},setVolume:function(a){this.backend.setVolume(a)},getVolume:function(){return this.backend.getVolume()},setPlaybackRate:function(a){this.backend.setPlaybackRate(a)},getPlaybackRate:function(){return this.backend.getPlaybackRate()},toggleMute:function(){this.setMute(!this.isMuted)},setMute:function(a){a!==this.isMuted&&(a?(this.savedVolume=this.backend.getVolume(),this.backend.setVolume(0),this.isMuted=!0):(this.backend.setVolume(this.savedVolume),this.isMuted=!1))},getMute:function(){return this.isMuted},getFilters:function(){return this.backend.filters||[]},toggleScroll:function(){this.params.scrollParent=!this.params.scrollParent,this.drawBuffer()},toggleInteraction:function(){this.params.interact=!this.params.interact},drawBuffer:function(){var a=Math.round(this.getDuration()*this.params.minPxPerSec*this.params.pixelRatio),b=this.drawer.getWidth(),c=a,d=this.drawer.getScrollX(),e=Math.min(d+b,c);if(this.params.fillParent&&(!this.params.scrollParent||a<b)&&(c=b,d=0,e=c),this.params.partialRender)for(var f=this.peakCache.addRangeToPeakCache(c,d,e),g=0;g<f.length;g++){var h=this.backend.getPeaks(c,f[g][0],f[g][1]);this.drawer.drawPeaks(h,c,f[g][0],f[g][1])}else{d=0,e=c;var h=this.backend.getPeaks(c,d,e);this.drawer.drawPeaks(h,c,d,e)}this.fireEvent("redraw",h,c)},zoom:function(a){this.params.minPxPerSec=a,this.params.scrollParent=!0,this.drawBuffer(),this.drawer.progress(this.backend.getPlayedPercents()),this.drawer.recenter(this.getCurrentTime()/this.getDuration()),this.fireEvent("zoom",a)},loadArrayBuffer:function(a){this.decodeArrayBuffer(a,function(a){this.isDestroyed||this.loadDecodedBuffer(a)}.bind(this))},loadDecodedBuffer:function(a){this.backend.load(a),this.drawBuffer(),this.fireEvent("ready")},loadBlob:function(a){var b=this,c=new FileReader;c.addEventListener("progress",function(a){b.onProgress(a)}),c.addEventListener("load",function(a){b.loadArrayBuffer(a.target.result)}),c.addEventListener("error",function(){b.fireEvent("error","Error reading file")}),c.readAsArrayBuffer(a),this.empty()},load:function(a,b,c){switch(this.empty(),this.params.backend){case"WebAudio":return this.loadBuffer(a,b);case"MediaElement":return this.loadMediaElement(a,b,c)}},loadBuffer:function(a,b){var c=function(b){return b&&this.tmpEvents.push(this.once("ready",b)),this.getArrayBuffer(a,this.loadArrayBuffer.bind(this))}.bind(this);return b?(this.backend.setPeaks(b),this.drawBuffer(),void this.tmpEvents.push(this.once("interaction",c))):c()},loadMediaElement:function(a,b,c){var d=a;if("string"==typeof a)this.backend.load(d,this.mediaContainer,b,c);else{var e=a;this.backend.loadElt(e,b),d=e.src}this.tmpEvents.push(this.backend.once("canplay",function(){this.drawBuffer(),this.fireEvent("ready")}.bind(this)),this.backend.once("error",function(a){this.fireEvent("error",a)}.bind(this))),b&&this.backend.setPeaks(b),b&&!this.params.forceDecode||!this.backend.supportsWebAudio()||this.getArrayBuffer(d,function(a){this.decodeArrayBuffer(a,function(a){this.backend.buffer=a,this.backend.setPeaks(null),this.drawBuffer(),this.fireEvent("waveform-ready")}.bind(this))}.bind(this))},decodeArrayBuffer:function(a,b){this.arraybuffer=a,this.backend.decodeArrayBuffer(a,function(c){this.isDestroyed||this.arraybuffer!=a||(b(c),this.arraybuffer=null)}.bind(this),this.fireEvent.bind(this,"error","Error decoding audiobuffer"))},getArrayBuffer:function(b,c){var d=this,e=a.util.ajax({url:b,responseType:"arraybuffer"});return this.currentAjax=e,this.tmpEvents.push(e.on("progress",function(a){d.onProgress(a)}),e.on("success",function(a,b){c(a),d.currentAjax=null}),e.on("error",function(a){d.fireEvent("error","XHR error: "+a.target.statusText),d.currentAjax=null})),e},onProgress:function(a){if(a.lengthComputable)var b=a.loaded/a.total;else b=a.loaded/(a.loaded+1e6);this.fireEvent("loading",Math.round(100*b),a.target)},exportPCM:function(a,b,c){a=a||1024,b=b||1e4,c=c||!1;var d=this.backend.getPeaks(a,b),e=[].map.call(d,function(a){return Math.round(a*b)/b}),f=JSON.stringify(e);return c||window.open("data:application/json;charset=utf-8,"+encodeURIComponent(f)),f},exportImage:function(a,b){return a||(a="image/png"),b||(b=1),this.drawer.getImage(a,b)},cancelAjax:function(){this.currentAjax&&(this.currentAjax.xhr.abort(),this.currentAjax=null)},clearTmpEvents:function(){this.tmpEvents.forEach(function(a){a.un()})},empty:function(){this.backend.isPaused()||(this.stop(),this.backend.disconnectSource()),this.cancelAjax(),this.clearTmpEvents(),this.drawer.progress(0),this.drawer.setWidth(0),this.drawer.drawPeaks({length:this.drawer.getWidth()},0)},destroy:function(){this.fireEvent("destroy"),this.cancelAjax(),this.clearTmpEvents(),this.unAll(),this.backend.destroy(),this.drawer.destroy(),this.isDestroyed=!0}};return a.create=function(b){var c=Object.create(a);return c.init(b),c},a.util={extend:function(a){return Array.prototype.slice.call(arguments,1).forEach(function(b){Object.keys(b).forEach(function(c){a[c]=b[c]})}),a},debounce:function(a,b,c){var d,e,f,g=function(){f=null,c||a.apply(e,d)};return function(){e=this,d=arguments;var h=c&&!f;clearTimeout(f),f=setTimeout(g,b),f||(f=setTimeout(g,b)),h&&a.apply(e,d)}},min:function(a){var b=1/0;for(var c in a)a[c]<b&&(b=a[c]);return b},max:function(a){var b=-1/0;for(var c in a)a[c]>b&&(b=a[c]);return b},getId:function(){return"wavesurfer_"+Math.random().toString(32).substring(2)},ajax:function(b){var c=Object.create(a.Observer),d=new XMLHttpRequest,e=!1;return d.open(b.method||"GET",b.url,!0),d.responseType=b.responseType||"json",d.addEventListener("progress",function(a){c.fireEvent("progress",a),a.lengthComputable&&a.loaded==a.total&&(e=!0)}),d.addEventListener("load",function(a){e||c.fireEvent("progress",a),c.fireEvent("load",a),200==d.status||206==d.status?c.fireEvent("success",d.response,a):c.fireEvent("error",a)}),d.addEventListener("error",function(a){c.fireEvent("error",a)}),d.send(),c.xhr=d,c}},a.Observer={on:function(a,b){this.handlers||(this.handlers={});var c=this.handlers[a];return c||(c=this.handlers[a]=[]),c.push(b),{name:a,callback:b,un:this.un.bind(this,a,b)}},un:function(a,b){if(this.handlers){var c=this.handlers[a];if(c)if(b)for(var d=c.length-1;d>=0;d--)c[d]==b&&c.splice(d,1);else c.length=0}},unAll:function(){this.handlers=null},once:function(a,b){var c=this,d=function(){b.apply(this,arguments),setTimeout(function(){c.un(a,d)},0)};return this.on(a,d)},fireEvent:function(a){if(this.handlers){var b=this.handlers[a],c=Array.prototype.slice.call(arguments,1);b&&b.forEach(function(a){a.apply(null,c)})}}},a.util.extend(a,a.Observer),a.WebAudio={scriptBufferSize:256,PLAYING_STATE:0,PAUSED_STATE:1,FINISHED_STATE:2,supportsWebAudio:function(){return!(!window.AudioContext&&!window.webkitAudioContext)},getAudioContext:function(){return a.WebAudio.audioContext||(a.WebAudio.audioContext=new(window.AudioContext||window.webkitAudioContext)),a.WebAudio.audioContext},getOfflineAudioContext:function(b){return a.WebAudio.offlineAudioContext||(a.WebAudio.offlineAudioContext=new(window.OfflineAudioContext||window.webkitOfflineAudioContext)(1,2,b)),a.WebAudio.offlineAudioContext},init:function(b){this.params=b,this.ac=b.audioContext||this.getAudioContext(),this.lastPlay=this.ac.currentTime,this.startPosition=0,this.scheduledPause=null,this.states=[Object.create(a.WebAudio.state.playing),Object.create(a.WebAudio.state.paused),Object.create(a.WebAudio.state.finished)],this.createVolumeNode(),this.createScriptNode(),this.createAnalyserNode(),this.setState(this.PAUSED_STATE),this.setPlaybackRate(this.params.audioRate),this.setLength(0)},disconnectFilters:function(){this.filters&&(this.filters.forEach(function(a){a&&a.disconnect()}),this.filters=null,this.analyser.connect(this.gainNode))},setState:function(a){this.state!==this.states[a]&&(this.state=this.states[a],this.state.init.call(this))},setFilter:function(){this.setFilters([].slice.call(arguments))},setFilters:function(a){this.disconnectFilters(),a&&a.length&&(this.filters=a,this.analyser.disconnect(),a.reduce(function(a,b){return a.connect(b),b},this.analyser).connect(this.gainNode))},createScriptNode:function(){this.ac.createScriptProcessor?this.scriptNode=this.ac.createScriptProcessor(this.scriptBufferSize):this.scriptNode=this.ac.createJavaScriptNode(this.scriptBufferSize),this.scriptNode.connect(this.ac.destination)},addOnAudioProcess:function(){var a=this;this.scriptNode.onaudioprocess=function(){var b=a.getCurrentTime();b>=a.getDuration()?(a.setState(a.FINISHED_STATE),a.fireEvent("pause")):b>=a.scheduledPause?a.pause():a.state===a.states[a.PLAYING_STATE]&&a.fireEvent("audioprocess",b)}},removeOnAudioProcess:function(){this.scriptNode.onaudioprocess=null},createAnalyserNode:function(){this.analyser=this.ac.createAnalyser(),this.analyser.connect(this.gainNode)},createVolumeNode:function(){this.ac.createGain?this.gainNode=this.ac.createGain():this.gainNode=this.ac.createGainNode(),this.gainNode.connect(this.ac.destination)},setVolume:function(a){this.gainNode.gain.value=a},getVolume:function(){return this.gainNode.gain.value},decodeArrayBuffer:function(a,b,c){this.offlineAc||(this.offlineAc=this.getOfflineAudioContext(this.ac?this.ac.sampleRate:44100)),this.offlineAc.decodeAudioData(a,function(a){b(a)}.bind(this),c)},setPeaks:function(a){this.peaks=a},setLength:function(a){if(!this.mergedPeaks||a!=2*this.mergedPeaks.length-1+2){this.splitPeaks=[],this.mergedPeaks=[];for(var b=this.buffer?this.buffer.numberOfChannels:1,c=0;c<b;c++)this.splitPeaks[c]=[],this.splitPeaks[c][2*(a-1)]=0,this.splitPeaks[c][2*(a-1)+1]=0;this.mergedPeaks[2*(a-1)]=0,this.mergedPeaks[2*(a-1)+1]=0}},getPeaks:function(a,b,c){if(this.peaks)return this.peaks;this.setLength(a);for(var d=this.buffer.length/a,e=~~(d/10)||1,f=this.buffer.numberOfChannels,g=0;g<f;g++)for(var h=this.splitPeaks[g],i=this.buffer.getChannelData(g),j=b;j<=c;j++){for(var k=~~(j*d),l=~~(k+d),m=0,n=0,o=k;o<l;o+=e){var p=i[o];p>n&&(n=p),p<m&&(m=p)}h[2*j]=n,h[2*j+1]=m,(0==g||n>this.mergedPeaks[2*j])&&(this.mergedPeaks[2*j]=n),(0==g||m<this.mergedPeaks[2*j+1])&&(this.mergedPeaks[2*j+1]=m)}return this.params.splitChannels?this.splitPeaks:this.mergedPeaks},getPlayedPercents:function(){return this.state.getPlayedPercents.call(this)},disconnectSource:function(){this.source&&this.source.disconnect()},destroy:function(){this.isPaused()||this.pause(),this.unAll(),this.buffer=null,this.disconnectFilters(),this.disconnectSource(),this.gainNode.disconnect(),this.scriptNode.disconnect(),this.analyser.disconnect(),this.params.closeAudioContext&&("function"==typeof this.ac.close&&"closed"!=this.ac.state&&this.ac.close(),this.ac=null,this.params.audioContext?this.params.audioContext=null:a.WebAudio.audioContext=null,a.WebAudio.offlineAudioContext=null)},load:function(a){this.startPosition=0,this.lastPlay=this.ac.currentTime,this.buffer=a,this.createSource()},createSource:function(){this.disconnectSource(),this.source=this.ac.createBufferSource(),this.source.start=this.source.start||this.source.noteGrainOn,this.source.stop=this.source.stop||this.source.noteOff,this.source.playbackRate.value=this.playbackRate,this.source.buffer=this.buffer,this.source.connect(this.analyser)},isPaused:function(){return this.state!==this.states[this.PLAYING_STATE]},getDuration:function(){return this.buffer?this.buffer.duration:0},seekTo:function(a,b){if(this.buffer)return this.scheduledPause=null,null==a&&(a=this.getCurrentTime())>=this.getDuration()&&(a=0),null==b&&(b=this.getDuration()),this.startPosition=a,this.lastPlay=this.ac.currentTime,this.state===this.states[this.FINISHED_STATE]&&this.setState(this.PAUSED_STATE),{start:a,end:b}},getPlayedTime:function(){return(this.ac.currentTime-this.lastPlay)*this.playbackRate},play:function(a,b){if(this.buffer){this.createSource();var c=this.seekTo(a,b);a=c.start,b=c.end,this.scheduledPause=b,this.source.start(0,a,b-a),"suspended"==this.ac.state&&this.ac.resume&&this.ac.resume(),this.setState(this.PLAYING_STATE),this.fireEvent("play")}},pause:function(){this.scheduledPause=null,this.startPosition+=this.getPlayedTime(),this.source&&this.source.stop(0),this.setState(this.PAUSED_STATE),this.fireEvent("pause")},getCurrentTime:function(){return this.state.getCurrentTime.call(this)},getPlaybackRate:function(){return this.playbackRate},setPlaybackRate:function(a){a=a||1,this.isPaused()?this.playbackRate=a:(this.pause(),this.playbackRate=a,this.play())}},a.WebAudio.state={},a.WebAudio.state.playing={init:function(){this.addOnAudioProcess()},getPlayedPercents:function(){var a=this.getDuration();return this.getCurrentTime()/a||0},getCurrentTime:function(){return this.startPosition+this.getPlayedTime()}},a.WebAudio.state.paused={init:function(){this.removeOnAudioProcess()},getPlayedPercents:function(){var a=this.getDuration();return this.getCurrentTime()/a||0},getCurrentTime:function(){return this.startPosition}},a.WebAudio.state.finished={init:function(){this.removeOnAudioProcess(),this.fireEvent("finish")},getPlayedPercents:function(){return 1},getCurrentTime:function(){return this.getDuration()}},a.util.extend(a.WebAudio,a.Observer),a.MediaElement=Object.create(a.WebAudio),a.util.extend(a.MediaElement,{init:function(a){this.params=a,this.media={currentTime:0,duration:0,paused:!0,playbackRate:1,play:function(){},pause:function(){}},this.mediaType=a.mediaType.toLowerCase(),this.elementPosition=a.elementPosition,this.setPlaybackRate(this.params.audioRate),this.createTimer()},createTimer:function(){var a=this,b=function(){if(!a.isPaused()){a.fireEvent("audioprocess",a.getCurrentTime());(window.requestAnimationFrame||window.webkitRequestAnimationFrame)(b)}};this.on("play",b)},load:function(a,b,c,d){var e=document.createElement(this.mediaType);e.controls=this.params.mediaControls,e.autoplay=this.params.autoplay||!1,e.preload=null==d?"auto":d,e.src=a,e.style.width="100%";var f=b.querySelector(this.mediaType);f&&b.removeChild(f),b.appendChild(e),this._load(e,c)},loadElt:function(a,b){var c=a;c.controls=this.params.mediaControls,c.autoplay=this.params.autoplay||!1,this._load(c,b)},_load:function(a,b){var c=this;"function"==typeof a.load&&a.load(),a.addEventListener("error",function(){c.fireEvent("error","Error loading media element")}),a.addEventListener("canplay",function(){c.fireEvent("canplay")}),a.addEventListener("ended",function(){c.fireEvent("finish")}),this.media=a,this.peaks=b,this.onPlayEnd=null,this.buffer=null,this.setPlaybackRate(this.playbackRate)},isPaused:function(){return!this.media||this.media.paused},getDuration:function(){var a=(this.buffer||this.media).duration;return a>=1/0&&(a=this.media.seekable.end(0)),a},getCurrentTime:function(){return this.media&&this.media.currentTime},getPlayedPercents:function(){return this.getCurrentTime()/this.getDuration()||0},getPlaybackRate:function(){return this.playbackRate||this.media.playbackRate},setPlaybackRate:function(a){this.playbackRate=a||1,this.media.playbackRate=this.playbackRate},seekTo:function(a){null!=a&&(this.media.currentTime=a),this.clearPlayEnd()},play:function(a,b){this.seekTo(a),this.media.play(),b&&this.setPlayEnd(b),this.fireEvent("play")},pause:function(){this.media&&this.media.pause(),this.clearPlayEnd(),this.fireEvent("pause")},setPlayEnd:function(a){var b=this;this.onPlayEnd=function(c){c>=a&&(b.pause(),b.seekTo(a))},this.on("audioprocess",this.onPlayEnd)},clearPlayEnd:function(){this.onPlayEnd&&(this.un("audioprocess",this.onPlayEnd),this.onPlayEnd=null)},getPeaks:function(b,c,d){return this.buffer?a.WebAudio.getPeaks.call(this,b,c,d):this.peaks||[]},getVolume:function(){return this.media.volume},setVolume:function(a){this.media.volume=a},destroy:function(){this.pause(),this.unAll(),this.media&&this.media.parentNode&&this.media.parentNode.removeChild(this.media),this.media=null}}),a.AudioElement=a.MediaElement,a.Drawer={init:function(a,b){this.container=a,this.params=b,this.width=0,this.height=b.height*this.params.pixelRatio,this.lastPos=0,this.initDrawer(b),this.createWrapper(),this.createElements()},createWrapper:function(){this.wrapper=this.container.appendChild(document.createElement("wave")),this.style(this.wrapper,{display:"block",position:"relative",userSelect:"none",webkitUserSelect:"none",height:this.params.height+"px"}),(this.params.fillParent||this.params.scrollParent)&&this.style(this.wrapper,{width:"100%",overflowX:this.params.hideScrollbar?"hidden":"auto",overflowY:"hidden"}),this.setupWrapperEvents()},handleEvent:function(a,b){!b&&a.preventDefault();var c,d=a.targetTouches?a.targetTouches[0].clientX:a.clientX,e=this.wrapper.getBoundingClientRect(),f=this.width,g=this.getWidth();return!this.params.fillParent&&f<g?(c=(d-e.left)*this.params.pixelRatio/f||0)>1&&(c=1):c=(d-e.left+this.wrapper.scrollLeft)/this.wrapper.scrollWidth||0,c},setupWrapperEvents:function(){var a=this;this.wrapper.addEventListener("click",function(b){var c=a.wrapper.offsetHeight-a.wrapper.clientHeight;if(0!=c){var d=a.wrapper.getBoundingClientRect();if(b.clientY>=d.bottom-c)return}a.params.interact&&a.fireEvent("click",b,a.handleEvent(b))}),this.wrapper.addEventListener("scroll",function(b){a.fireEvent("scroll",b)})},drawPeaks:function(a,b,c,d){this.setWidth(b),this.params.barWidth?this.drawBars(a,0,c,d):this.drawWave(a,0,c,d)},style:function(a,b){return Object.keys(b).forEach(function(c){a.style[c]!==b[c]&&(a.style[c]=b[c])}),a},resetScroll:function(){null!==this.wrapper&&(this.wrapper.scrollLeft=0)},recenter:function(a){var b=this.wrapper.scrollWidth*a;this.recenterOnPosition(b,!0)},recenterOnPosition:function(a,b){var c=this.wrapper.scrollLeft,d=~~(this.wrapper.clientWidth/2),e=a-d,f=e-c,g=this.wrapper.scrollWidth-this.wrapper.clientWidth;if(0!=g){if(!b&&-d<=f&&f<d){var h=5;f=Math.max(-h,Math.min(h,f)),e=c+f}(e=Math.max(0,Math.min(g,e)))!=c&&(this.wrapper.scrollLeft=e)}},getScrollX:function(){return Math.round(this.wrapper.scrollLeft*this.params.pixelRatio)},getWidth:function(){return Math.round(this.container.clientWidth*this.params.pixelRatio)},setWidth:function(a){this.width!=a&&(this.width=a,this.params.fillParent||this.params.scrollParent?this.style(this.wrapper,{width:""}):this.style(this.wrapper,{width:~~(this.width/this.params.pixelRatio)+"px"}),this.updateSize())},setHeight:function(a){a!=this.height&&(this.height=a,this.style(this.wrapper,{height:~~(this.height/this.params.pixelRatio)+"px"}),this.updateSize())},progress:function(a){var b=1/this.params.pixelRatio,c=Math.round(a*this.width)*b;if(c<this.lastPos||c-this.lastPos>=b){if(this.lastPos=c,this.params.scrollParent&&this.params.autoCenter){var d=~~(this.wrapper.scrollWidth*a);this.recenterOnPosition(d)}this.updateProgress(c)}},destroy:function(){this.unAll(),this.wrapper&&(this.container.removeChild(this.wrapper),this.wrapper=null)},initDrawer:function(){},createElements:function(){},updateSize:function(){},drawWave:function(a,b){},clearWave:function(){},updateProgress:function(a){}},a.util.extend(a.Drawer,a.Observer),a.Drawer.Canvas=Object.create(a.Drawer),a.util.extend(a.Drawer.Canvas,{createElements:function(){var a=this.wrapper.appendChild(this.style(document.createElement("canvas"),{position:"absolute",zIndex:1,left:0,top:0,bottom:0}));if(this.waveCc=a.getContext("2d"),this.progressWave=this.wrapper.appendChild(this.style(document.createElement("wave"),{position:"absolute",zIndex:2,left:0,top:0,bottom:0,overflow:"hidden",width:"0",display:"none",boxSizing:"border-box",borderRightStyle:"solid",borderRightWidth:this.params.cursorWidth+"px",borderRightColor:this.params.cursorColor})),this.params.waveColor!=this.params.progressColor){var b=this.progressWave.appendChild(document.createElement("canvas"))
;this.progressCc=b.getContext("2d")}},updateSize:function(){var a=Math.round(this.width/this.params.pixelRatio);this.waveCc.canvas.width=this.width,this.waveCc.canvas.height=this.height,this.style(this.waveCc.canvas,{width:a+"px"}),this.style(this.progressWave,{display:"block"}),this.progressCc&&(this.progressCc.canvas.width=this.width,this.progressCc.canvas.height=this.height,this.style(this.progressCc.canvas,{width:a+"px"})),this.clearWave()},clearWave:function(){this.waveCc.clearRect(0,0,this.width,this.height),this.progressCc&&this.progressCc.clearRect(0,0,this.width,this.height)},drawBars:function(b,c,d,e){var f=this;if(b[0]instanceof Array){var g=b;if(this.params.splitChannels)return this.setHeight(g.length*this.params.height*this.params.pixelRatio),void g.forEach(function(a,b){f.drawBars(a,b,d,e)});b=g[0]}var h=[].some.call(b,function(a){return a<0}),i=1;h&&(i=2);var j=.5/this.params.pixelRatio,k=this.width,l=this.params.height*this.params.pixelRatio,m=l*c||0,n=l/2,o=b.length/i,p=this.params.barWidth*this.params.pixelRatio,q=Math.max(this.params.pixelRatio,~~(p/2)),r=p+q,s=1/this.params.barHeight;if(this.params.normalize){var t=a.util.max(b),u=a.util.min(b);s=-u>t?-u:t}var v=o/k;this.waveCc.fillStyle=this.params.waveColor,this.progressCc&&(this.progressCc.fillStyle=this.params.progressColor),[this.waveCc,this.progressCc].forEach(function(a){if(a)for(var c=d/v;c<e/v;c+=r){var f=b[Math.floor(c*v*i)]||0,g=Math.round(f/s*n);a.fillRect(c+j,n-g+m,p+j,2*g)}},this)},drawWave:function(b,c,d,e){var f=this;if(b[0]instanceof Array){var g=b;if(this.params.splitChannels)return this.setHeight(g.length*this.params.height*this.params.pixelRatio),void g.forEach(function(a,b){f.drawWave(a,b,d,e)});b=g[0]}if(![].some.call(b,function(a){return a<0})){for(var h=[],i=0,j=b.length;i<j;i++)h[2*i]=b[i],h[2*i+1]=-b[i];b=h}var k=.5/this.params.pixelRatio,l=this.params.height*this.params.pixelRatio,m=l*c||0,n=l/2,o=~~(b.length/2),p=1;this.params.fillParent&&this.width!=o&&(p=this.width/o);var q=1/this.params.barHeight;if(this.params.normalize){var r=a.util.max(b),s=a.util.min(b);q=-s>r?-s:r}this.waveCc.fillStyle=this.params.waveColor,this.progressCc&&(this.progressCc.fillStyle=this.params.progressColor),[this.waveCc,this.progressCc].forEach(function(a){if(a){a.beginPath(),a.moveTo(d*p+k,n+m);for(var c=d;c<e;c++){var f=Math.round(b[2*c]/q*n);a.lineTo(c*p+k,n-f+m)}for(var c=e-1;c>=d;c--){var f=Math.round(b[2*c+1]/q*n);a.lineTo(c*p+k,n-f+m)}a.closePath(),a.fill(),a.fillRect(0,n+m-k,this.width,k)}},this)},updateProgress:function(a){this.style(this.progressWave,{width:a+"px"})},getImage:function(a,b){return this.waveCc.canvas.toDataURL(a,b)}}),a.Drawer.MultiCanvas=Object.create(a.Drawer),a.util.extend(a.Drawer.MultiCanvas,{initDrawer:function(a){if(this.maxCanvasWidth=null!=a.maxCanvasWidth?a.maxCanvasWidth:4e3,this.maxCanvasElementWidth=Math.round(this.maxCanvasWidth/this.params.pixelRatio),this.maxCanvasWidth<=1)throw"maxCanvasWidth must be greater than 1.";if(this.maxCanvasWidth%2==1)throw"maxCanvasWidth must be an even number.";this.hasProgressCanvas=this.params.waveColor!=this.params.progressColor,this.halfPixel=.5/this.params.pixelRatio,this.canvases=[]},createElements:function(){this.progressWave=this.wrapper.appendChild(this.style(document.createElement("wave"),{position:"absolute",zIndex:2,left:0,top:0,bottom:0,overflow:"hidden",width:"0",display:"none",boxSizing:"border-box",borderRightStyle:"solid",borderRightWidth:this.params.cursorWidth+"px",borderRightColor:this.params.cursorColor})),this.addCanvas()},updateSize:function(){for(var a=Math.round(this.width/this.params.pixelRatio),b=Math.ceil(a/this.maxCanvasElementWidth);this.canvases.length<b;)this.addCanvas();for(;this.canvases.length>b;)this.removeCanvas();for(var c in this.canvases){var d=this.maxCanvasWidth+2*Math.ceil(this.params.pixelRatio/2);c==this.canvases.length-1&&(d=this.width-this.maxCanvasWidth*(this.canvases.length-1)),this.updateDimensions(this.canvases[c],d,this.height),this.clearWaveForEntry(this.canvases[c])}},addCanvas:function(){var a={},b=this.maxCanvasElementWidth*this.canvases.length;a.wave=this.wrapper.appendChild(this.style(document.createElement("canvas"),{position:"absolute",zIndex:1,left:b+"px",top:0,bottom:0})),a.waveCtx=a.wave.getContext("2d"),this.hasProgressCanvas&&(a.progress=this.progressWave.appendChild(this.style(document.createElement("canvas"),{position:"absolute",left:b+"px",top:0,bottom:0})),a.progressCtx=a.progress.getContext("2d")),this.canvases.push(a)},removeCanvas:function(){var a=this.canvases.pop();a.wave.parentElement.removeChild(a.wave),this.hasProgressCanvas&&a.progress.parentElement.removeChild(a.progress)},updateDimensions:function(a,b,c){var d=Math.round(b/this.params.pixelRatio),e=Math.round(this.width/this.params.pixelRatio);a.start=a.waveCtx.canvas.offsetLeft/e||0,a.end=a.start+d/e,a.waveCtx.canvas.width=b,a.waveCtx.canvas.height=c,this.style(a.waveCtx.canvas,{width:d+"px"}),this.style(this.progressWave,{display:"block"}),this.hasProgressCanvas&&(a.progressCtx.canvas.width=b,a.progressCtx.canvas.height=c,this.style(a.progressCtx.canvas,{width:d+"px"}))},clearWave:function(){for(var a in this.canvases)this.clearWaveForEntry(this.canvases[a])},clearWaveForEntry:function(a){a.waveCtx.clearRect(0,0,a.waveCtx.canvas.width,a.waveCtx.canvas.height),this.hasProgressCanvas&&a.progressCtx.clearRect(0,0,a.progressCtx.canvas.width,a.progressCtx.canvas.height)},drawBars:function(b,c,d,e){var f=this;if(b[0]instanceof Array){var g=b;if(this.params.splitChannels)return this.setHeight(g.length*this.params.height*this.params.pixelRatio),void g.forEach(function(a,b){f.drawBars(a,b,d,e)});b=g[0]}var h=[].some.call(b,function(a){return a<0}),i=1;h&&(i=2);var j=this.width,k=this.params.height*this.params.pixelRatio,l=k*c||0,m=k/2,n=b.length/i,o=this.params.barWidth*this.params.pixelRatio,p=Math.max(this.params.pixelRatio,~~(o/2)),q=o+p,r=1/this.params.barHeight;if(this.params.normalize){var s=a.util.max(b),t=a.util.min(b);r=-t>s?-t:s}for(var u=n/j,v=d/u;v<e/u;v+=q){var w=b[Math.floor(v*u*i)]||0,x=Math.round(w/r*m);this.fillRect(v+this.halfPixel,m-x+l,o+this.halfPixel,2*x)}},drawWave:function(b,c,d,e){var f=this;if(b[0]instanceof Array){var g=b;if(this.params.splitChannels)return this.setHeight(g.length*this.params.height*this.params.pixelRatio),void g.forEach(function(a,b){f.drawWave(a,b,d,e)});b=g[0]}if(![].some.call(b,function(a){return a<0})){for(var h=[],i=0,j=b.length;i<j;i++)h[2*i]=b[i],h[2*i+1]=-b[i];b=h}var k=this.params.height*this.params.pixelRatio,l=k*c||0,m=k/2,n=1/this.params.barHeight;if(this.params.normalize){var o=a.util.max(b),p=a.util.min(b);n=-p>o?-p:o}this.drawLine(b,n,m,l,d,e),this.fillRect(0,m+l-this.halfPixel,this.width,this.halfPixel)},drawLine:function(a,b,c,d,e,f){for(var g in this.canvases){var h=this.canvases[g];this.setFillStyles(h),this.drawLineToContext(h,h.waveCtx,a,b,c,d,e,f),this.drawLineToContext(h,h.progressCtx,a,b,c,d,e,f)}},drawLineToContext:function(a,b,c,d,e,f,g,h){if(b){var i=c.length/2,j=1;this.params.fillParent&&this.width!=i&&(j=this.width/i);var k=Math.round(i*a.start),l=Math.round(i*a.end);if(!(k>h||l<g)){var m=Math.max(k,g),n=Math.min(l,h);b.beginPath(),b.moveTo((m-k)*j+this.halfPixel,e+f);for(var o=m;o<n;o++){var p=c[2*o]||0,q=Math.round(p/d*e);b.lineTo((o-k)*j+this.halfPixel,e-q+f)}for(var o=n-1;o>=m;o--){var p=c[2*o+1]||0,q=Math.round(p/d*e);b.lineTo((o-k)*j+this.halfPixel,e-q+f)}b.closePath(),b.fill()}}},fillRect:function(a,b,c,d){for(var e=Math.floor(a/this.maxCanvasWidth),f=Math.min(Math.ceil((a+c)/this.maxCanvasWidth)+1,this.canvases.length),g=e;g<f;g++){var h=this.canvases[g],i=g*this.maxCanvasWidth,j={x1:Math.max(a,g*this.maxCanvasWidth),y1:b,x2:Math.min(a+c,g*this.maxCanvasWidth+h.waveCtx.canvas.width),y2:b+d};j.x1<j.x2&&(this.setFillStyles(h),this.fillRectToContext(h.waveCtx,j.x1-i,j.y1,j.x2-j.x1,j.y2-j.y1),this.fillRectToContext(h.progressCtx,j.x1-i,j.y1,j.x2-j.x1,j.y2-j.y1))}},fillRectToContext:function(a,b,c,d,e){a&&a.fillRect(b,c,d,e)},setFillStyles:function(a){a.waveCtx.fillStyle=this.params.waveColor,this.hasProgressCanvas&&(a.progressCtx.fillStyle=this.params.progressColor)},updateProgress:function(a){this.style(this.progressWave,{width:a+"px"})},getImage:function(a,b){var c=[];return this.canvases.forEach(function(d){c.push(d.wave.toDataURL(a,b))}),c.length>1?c:c[0]}}),a.Drawer.SplitWavePointPlot=Object.create(a.Drawer.Canvas),a.util.extend(a.Drawer.SplitWavePointPlot,{defaultPlotParams:{plotNormalizeTo:"whole",plotTimeStart:0,plotMin:0,plotMax:1,plotColor:"#f63",plotProgressColor:"#F00",plotPointHeight:2,plotPointWidth:2,plotSeparator:!0,plotSeparatorColor:"black",plotRangeDisplay:!1,plotRangeUnits:"",plotRangePrecision:4,plotRangeIgnoreOutliers:!1,plotRangeFontSize:12,plotRangeFontType:"Ariel",waveDrawMedianLine:!0,plotFileDelimiter:"\t"},plotTimeStart:0,plotTimeEnd:-1,plotArrayLoaded:!1,plotArray:[],plotPoints:[],plotMin:0,plotMax:1,initDrawer:function(a){var b=this;for(var c in this.defaultPlotParams)void 0===this.params[c]&&(this.params[c]=this.defaultPlotParams[c]);if(this.plotTimeStart=this.params.plotTimeStart,void 0!==this.params.plotTimeEnd&&(this.plotTimeEnd=this.params.plotTimeEnd),Array.isArray(a.plotArray))this.plotArray=a.plotArray,this.plotArrayLoaded=!0;else{var d=function(a){b.plotArray=a,b.plotArrayLoaded=!0,b.fireEvent("plot_array_loaded")};this.loadPlotArrayFromFile(a.plotFileUrl,d,this.params.plotFileDelimiter)}},drawPeaks:function(a,b,c,d){if(1==this.plotArrayLoaded)this.setWidth(b),this.splitChannels=!0,this.params.height=this.params.height/2,a[0]instanceof Array&&(a=a[0]),this.params.barWidth?this.drawBars(a,1,c,d):this.drawWave(a,1,c,d),this.params.height=2*this.params.height,this.calculatePlots(),this.drawPlots();else{var e=this;e.on("plot-array-loaded",function(){e.drawPeaks(a,b,c,d)})}},drawPlots:function(){var a=this.params.height*this.params.pixelRatio/2,b=.5/this.params.pixelRatio;this.waveCc.fillStyle=this.params.plotColor,this.progressCc&&(this.progressCc.fillStyle=this.params.plotProgressColor);for(var c in this.plotPoints){var d=parseInt(c),e=a-this.params.plotPointHeight-this.plotPoints[c]*(a-this.params.plotPointHeight),f=this.params.plotPointHeight;this.waveCc.fillRect(d,e,this.params.plotPointWidth,f),this.progressCc&&this.progressCc.fillRect(d,e,this.params.plotPointWidth,f)}this.params.plotSeparator&&(this.waveCc.fillStyle=this.params.plotSeparatorColor,this.waveCc.fillRect(0,a,this.width,b)),this.params.plotRangeDisplay&&this.displayPlotRange()},displayPlotRange:function(){var a=this.params.plotRangeFontSize*this.params.pixelRatio,b=this.plotMax.toPrecision(this.params.plotRangePrecision)+" "+this.params.plotRangeUnits,c=this.plotMin.toPrecision(this.params.plotRangePrecision)+" "+this.params.plotRangeUnits;this.waveCc.font=a.toString()+"px "+this.params.plotRangeFontType,this.waveCc.fillText(b,3,a),this.waveCc.fillText(c,3,this.height/2)},calculatePlots:function(){this.plotPoints={},this.calculatePlotTimeEnd();for(var a=[],b=-1,c=0,d=99999999999999,e=0,f=99999999999999,g=this.plotTimeEnd-this.plotTimeStart,h=0;h<this.plotArray.length;h++){var i=this.plotArray[h];if(i.value>c&&(c=i.value),i.value<d&&(d=i.value),i.time>=this.plotTimeStart&&i.time<=this.plotTimeEnd){var j=Math.round(this.width*(i.time-this.plotTimeStart)/g);if(a.push(i.value),j!==b&&a.length>0){var k=this.avg(a);k>e&&(e=k),k<f&&(f=k),this.plotPoints[b]=k,a=[]}b=j}}"whole"==this.params.plotNormalizeTo?(this.plotMin=d,this.plotMax=c):"values"==this.params.plotNormalizeTo?(this.plotMin=this.params.plotMin,this.plotMax=this.params.plotMax):(this.plotMin=f,this.plotMax=e),this.normalizeValues()},normalizeValues:function(){var a={};if("none"!==this.params.plotNormalizeTo){for(var b in this.plotPoints){var c=(this.plotPoints[b]-this.plotMin)/(this.plotMax-this.plotMin);c>1?this.params.plotRangeIgnoreOutliers||(a[b]=1):c<0?this.params.plotRangeIgnoreOutliers||(a[b]=0):a[b]=c}this.plotPoints=a}},loadPlotArrayFromFile:function(b,c,d){void 0===d&&(d="\t");var e=[],f={url:b,responseType:"text"};a.util.ajax(f).on("load",function(a){if(200==a.currentTarget.status){for(var b=a.currentTarget.responseText.split("\n"),f=0;f<b.length;f++){var g=b[f].split(d);2==g.length&&e.push({time:parseFloat(g[0]),value:parseFloat(g[1])})}c(e)}})},calculatePlotTimeEnd:function(){void 0!==this.params.plotTimeEnd?this.plotTimeEnd=this.params.plotTimeEnd:this.plotTimeEnd=this.plotArray[this.plotArray.length-1].time},avg:function(a){return a.reduce(function(a,b){return a+b})/a.length}}),a.util.extend(a.Drawer.SplitWavePointPlot,a.Observer),a.PeakCache={init:function(){this.clearPeakCache()},clearPeakCache:function(){this.peakCacheRanges=[],this.peakCacheLength=-1},addRangeToPeakCache:function(a,b,c){a!=this.peakCacheLength&&(this.clearPeakCache(),this.peakCacheLength=a);for(var d=[],e=0;e<this.peakCacheRanges.length&&this.peakCacheRanges[e]<b;)e++;for(e%2==0&&d.push(b);e<this.peakCacheRanges.length&&this.peakCacheRanges[e]<=c;)d.push(this.peakCacheRanges[e]),e++;e%2==0&&d.push(c),d=d.filter(function(a,b,c){return 0==b?a!=c[b+1]:b==c.length-1?a!=c[b-1]:a!=c[b-1]&&a!=c[b+1]}),this.peakCacheRanges=this.peakCacheRanges.concat(d),this.peakCacheRanges=this.peakCacheRanges.sort(function(a,b){return a-b}).filter(function(a,b,c){return 0==b?a!=c[b+1]:b==c.length-1?a!=c[b-1]:a!=c[b-1]&&a!=c[b+1]});var f=[];for(e=0;e<d.length;e+=2)f.push([d[e],d[e+1]]);return f},getCacheRanges:function(){for(var a=[],b=0;b<this.peakCacheRanges.length;b+=2)a.push([this.peakCacheRanges[b],this.peakCacheRanges[b+1]]);return a}},function(){var b=function(){var b=document.querySelectorAll("wavesurfer");Array.prototype.forEach.call(b,function(b){var c=a.util.extend({container:b,backend:"MediaElement",mediaControls:!0},b.dataset);b.style.display="block";var d=a.create(c);if(b.dataset.peaks)var e=JSON.parse(b.dataset.peaks);d.load(b.dataset.url,e)})};"complete"===document.readyState?b():window.addEventListener("load",b)}(),a}),$.fn.left=function(a){var b=$(this);return a?b.offset({left:a}):b.offset().left},$.fn.right=function(a){var b=$(this);return a?b.offset({left:a-b.width()}):b.offset().left+b.width()},$.fn.top=function(a){var b=$(this);return a?b.offset({top:a}):b.offset().top},$.fn.bottom=function(a){var b=$(this);return a?b.offset({top:a-b.height()}):b.offset().top+b.height()},jQuery(document).on("click",".panel > label .toggle",function(a){var b=$(this).closest(".panel");b.toggleClass("collapsed"),localStorage.setItem("editor-panels-"+b[0].id+"-collapsed",b.is(".collapsed"))}).on("dblclick",".panel > label",function(a){$(this).find(".toggle").click()}).on("click",".panel li .toggleGroup",function(a){$(this).closest("li").toggleClass("open"),a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation()}).on("change",".flag_changer",function(a){var b=$(this);_.set(FLAGS,b.data("flag"),b.is(":checked"))}),jQuery(".panel").each(function(){var a=$(this),b=localStorage.getItem("editor-panels-"+this.id+"-collapsed");a.draggable({handle:">label",containment:[0,0,$(window).width()-a.width(),$(window).height()-a.height()],stop:function(){localStorage.setItem("editor-panels-"+a[0].id+"-pos",JSON.stringify(a.offset()))}}).toggleClass("collapsed","true"==b);var c=localStorage.getItem("editor-panels-"+a[0].id+"-pos");(c=c&&JSON.parse(c))&&a.css(c)}),sceneSelection=function(a){var b=new Set;return a&&b.add(a),Object.defineProperty(b,"single",{get:function(){return this.values().next().value},enumerable:!1,configurable:!1}),b.unselect=function(a){return this.forEach(function(a){a&&a.data.$layer.removeClass("open")}),"Project"===_.get(a,"className")?(a.deselectAll(),this.clear()):(a.fullySelected=!1,this.delete(a)),b},b},function(){"use strict";function a(a,b,c){return a.splice(b,!c||1+c-b+(!(c<0^b>=0)&&(c<0||-1)*a.length)),a.length}var b=function(){var b,c,d=[],e=-1,f=0,g=!1;return c=function(a,b){return a&&"function"==typeof a[b]?(g=!0,a[b](),g=!1,this):this},{add:function(c){return g?this:(d.splice(e+1,d.length-e),d.push(c),f&&d.length>f&&a(d,0,-(f+1)),e=d.length-1,b&&b(),this)},setCallback:function(a){b=a},undo:function(){var a=d[e];return a?(c(a,"undo"),e-=1,b&&b(),this):this},redo:function(){var a=d[e+1];return a?(c(a,"redo"),e+=1,b&&b(),this):this},clear:function(){var a=d.length;d=[],e=-1,b&&a>0&&b()},hasUndo:function(){return-1!==e},hasRedo:function(){return e<d.length-1},getCommands:function(){return d},getIndex:function(){return e},setLimit:function(a){f=a}}};"function"==typeof define&&"object"==typeof define.amd&&define.amd?define(function(){return b}):"undefined"!=typeof module&&module.exports?module.exports=b:window.UndoManager=b}();var Undos=new UndoManager;undoHistory={index:0,title:"",goto:function(a){for(;a>undoHistory.index;)undoHistory.redo();for(;a<undoHistory.index;)undoHistory.undo()},undo:function(){Undos.hasUndo()&&(Undos.undo(),undoHistory.index--,console.log("newIndex",undoHistory.index))},redo:function(){Undos.hasRedo()&&(Undos.redo(),undoHistory.index++,console.log("newIndex",undoHistory.index))}},history.replaceState({undoIndex:0},""),jQuery(window).on("popstate",function(a,b){undoHistory.goto(a.originalEvent.state.undoIndex)});var currentGame,tracks={},events={},TIME_FACTOR=10,FLAGS={view:{selection:!0}},_PANELS={layers:{},animations:{},audio:{},properties:{}},_loadingStates=[],_snapKeyframes=new Snappables(.4),selectedElements=sceneSelection(),$time,$animationValue,$currentTrack,_anchorViz,_playing=!1,_frameDragging=!1,_timeScrubbing=!1,_ANIMATABLE_COLORS={saturation:{range:[0,1],type:Number},brightness:{range:[0,1],type:Number},hue:{range:[0,360],type:Number},alpha:{range:[0,1],type:Number}},_ANIMATABLE_GEOMETRY={fillColor:_asGroup(_ANIMATABLE_COLORS),strokeColor:_asGroup(_ANIMATABLE_COLORS),strokeWidth:{range:[0,100],type:Number}},_ANIMATABLE_PIVOT={_x:{type:Number},_y:{type:Number}},_ANIMATABLE_POS={x:{type:Number},y:{type:Number}},_ANIMATABLE_SIZE={width:{type:Number},height:{type:Number}},_ANIMATABLE_RECT=_.extend({},_ANIMATABLE_POS,_ANIMATABLE_SIZE,{left:{type:Number},top:{type:Number},right:{type:Number},bottom:{type:Number},point:_asGroup(_ANIMATABLE_POS)}),_ANIMATABLE_GROUP={frame:{range:[0,Math.Infinity],type:Number},offsetOnPath:{range:[0,1],type:Number},state:{allowedValues:[],type:String}},_ANIMATABLE_DEFAULTS={blendMode:{allowedValues:["normal","multiply","screen","overlay","soft-light","hard- light","color-dodge","color-burn","darken","lighten","difference","exclusion","hue","saturation","luminosity","color","add","subtract","average","pin-light","negation","source- over","source-in","source-out","source-atop","destination-over","destination-in","destination-out","destination-atop","lighter","darker","copy","xor"],type:String},bounds:_asGroup(_ANIMATABLE_RECT),opacity:{range:[0,1],type:Number},pivot:_asGroup(_ANIMATABLE_POS),position:_asGroup(_ANIMATABLE_POS),rotation:{range:[-360,360],type:Number},visible:{type:Boolean}},ANIMATABLE_PROPERTIES={Path:_.extend({},_ANIMATABLE_DEFAULTS,_ANIMATABLE_GEOMETRY,_ANIMATABLE_GROUP,{growth:{range:[0,1],type:Number},segments:{type:"elements"}}),Segment:_asGroup({point:_asGroup(_ANIMATABLE_PIVOT),handleIn:_asGroup(_ANIMATABLE_PIVOT),handleOut:_asGroup(_ANIMATABLE_PIVOT)}),SymbolItem:_ANIMATABLE_DEFAULTS,Group:_.extend({},_ANIMATABLE_DEFAULTS,_ANIMATABLE_GROUP),PointText:_.extend({},_ANIMATABLE_DEFAULTS,_ANIMATABLE_GEOMETRY)},_HOVER_STYLES={PATHS:{opacity:1,strokeColor:"#009dec",strokeWidth:1,fillColor:null},TEXT:{opacity:1,strokeWidth:0,fillColor:"#009dec"}},_isBoundsItem=function(a){return["PlacedSymbol","Group","SymbolItem","Raster"].indexOf(a.className)>=0},_normalizeCaller=function(a){return a.match(/^danimator([A-Z].*)?$/g)||"onGameStart"===a||!a.length?"root":a};Danimator.animate=function a(b,c,d,e,f,g){var h="frame"===c?null:"cubicOut",i=(g&&g.delay,_normalizeCaller(a.caller.caller.name)),j=tracks[b.id]||{item:b,properties:{},startTime:(new Date).getTime()-Danimator.startTime},k=_.get(j.properties,c,[]),g=_.defaults(g,{delay:0,easing:h});b.data._animationsStart||(b.data._animationsStart=_getStartTime({options:g,duration:f})),_getStartTime({options:g,duration:f})<=_.get(b.data,"_animationsStart",1e4)&&_.set(b,c,d);var l={from:d,to:e,initValue:_.get(b,c),duration:f||1,options:g,caller:i,name:_getAnimationName(b,c,Danimator.caller&&Danimator.caller.name),id:k.length},m=_.find(k,{options:{delay:g.delay}});return m&&_.pull(k,m),k.push(l),j.maxDuration=Math.max(j.maxDuration||0,g.delay+(f||1)),Danimator.maxDuration=Math.max(Danimator.maxDuration||0,j.maxDuration),j.properties[c]=k,tracks[b.id]=j,_.debounce(_createTracks,1e3)(),{duration:f,options:g,then:Danimator.then,stop:noop}},Danimator.load=function(a){var b=a+".ani.json";$.getJSON(b,null,function(a,c){"success"===c?(_.each(a,function(a,b){isNaN(Number(b))||(b=Number(b)),a.item=paper.project.getItem({id:b})}),tracks=_.extend(tracks,a),_createTracks(),Danimator.time=Danimator.time):console.warn('Animations "'+b+"\" couldn't be loaded :(")}).fail(function(a,b,c){console.error(c)})},Danimator.onStep=function(a,b){selectedElements.has(Danimator.sceneElement(a.item))&&_changesProp(a.property,b)},Danimator.onMorph=function(){_createLayers(Danimator.layers,_PANELS.layers.$element.find("ul").empty())},Danimator.save=function(a,b){return $.ajax({url:"http://localhost:8080/save",type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify({file:b,content:JSON.stringify(a)}),success:function(a){console.log("we are back with",a)}})},Danimator.interactive=!0,jQuery(function(a){var b,c,d=0;_.each(_PANELS,function(b,c){var d=document.getElementById(c+"-panel-item").content.children[0].outerHTML;return b.template=_.template(_.unescape(d)),b.$element=a("#"+c+"-panel"),b}),_PANELS.properties.emptyState={template:_.template(_.unescape(document.getElementById("properties-panel-empty-item").content.children[0].outerHTML))},$time=_PANELS.animations.$element.find(".description time"),$animationValue=_PANELS.animations.$element.find(".description output"),a(document).on("click",".panel .layer",function(b){a(this).trigger(a.Event("selected",{handpicked:!0,item:Danimator.sceneElement(this).item})),b.preventDefault(),b.stopPropagation(),b.stopImmediatePropagation()}).on("selected",".panel .layer",function(b){var c=a(this),d=(c.data("id"),!c.is(".selected"));_resetSelection(),FLAGS.view.selection&&(b.item.fullySelected=d);var e=_PANELS.layers.$element.find("ul.main"),f=c.parentsUntil(e).andSelf().filter(".layer").toggleClass("selected",d);e.scrollTop(c[0].offsetTop-(e.height()-c.height())/2),b.handpicked&&f.toggleClass("open",d),_PANELS.animations.$element.toggleClass("hasSelection",d),d&&(selectedElements.add(Danimator.sceneElement(c)),_PANELS.properties.$element.find(".type").text(" OF "+b.item.className+" "+(b.item.name||"")),_createProperties(ANIMATABLE_PROPERTIES[b.item.className],_PANELS.properties.$element.find("ul.main").empty(),b.item),_anchorViz.position=b.item.pivot||b.item.bounds.center,_anchorViz.visible=!0),b.preventDefault(),b.stopPropagation(),b.stopImmediatePropagation()}).on("mousedown",".panel .layer .visible",function(d){b=a(this).closest(".layer").is(".hidden")+0,c=this}).on("mouseenter",".panel .layer .visible:visible",function(c){if(b>-1){var d=a(this).closest(".layer");!d.is(".hidden")!=b&&d.find(".visible").click()}}).on("mouseleave",".panel .layer .visible",function(d){b>-1&&c===this&&a(this).closest(".layer").toggleClass("hidden",b)}).on("click",".panel .layer .visible",function(b){var c=a(this).closest(".layer"),d=!c.is(".hidden");c.toggleClass("hidden"),Danimator.sceneElement(c).item.visible=!d,b.preventDefault(),b.stopPropagation(),b.stopImmediatePropagation()}).on("blur","time",function(b){var c=a(this),d=Number(c.text().replace(/[^\d\.\,]*/g,""));isNaN(d)?d=Danimator.time:Danimator.time=d,c.text(d+"s")}).on("dblclick","time",function(b){a(this).text(0).trigger("blur")}).on("input",".zoom",function(b){var c=Danimator.limit(a(this).val(),1,100)/100,d=5,e=60;TIME_FACTOR=_linearTolog(1-c,d,e),a(this).attr("title",parseInt(10+(TIME_FACTOR-d)/(e-d)*190)+"%"),_.each(Danimator.sounds,function(a){a.wave.zoom(TIME_FACTOR)}),_createTracks()}).on("dblclick",".zoom",function(b){a(this).val(50).trigger("input")}).on("mousedown",".timeline .track",function(b){a(b.target).is(".keyframe")&&(_frameDragging=!0),_frameDragging||(_timeScrubbing=!0,b.type="mousemove",a(this).trigger(b).addClass("scrubbing"),Danimator._activeSound&&Danimator._activeSound.wave.play(Danimator.time,Danimator.time+.08),_PANELS.animations.$element.removeClass("hasSelection"))}).on("mousemove",".timeline .track",function(b){if(!_frameDragging&&_timeScrubbing){var c=a(b.currentTarget),d=b.clientX-c.offset().left-1,e=d/TIME_FACTOR;b.shiftKey&&(e=_snapKeyframes.snap(e)),$currentTrack=c,Danimator.time=e,Danimator._activeSound&&Danimator._activeSound.wave.play(Danimator.time,Danimator.time+.08)}}).on("mouseup",".timeline .track",function(b){a(this).removeClass("scrubbing")}).on("dblclick","#animations-panel .keyframe",function(b){var c=a(this),d=c.closest("li.timeline").data("property"),e=Danimator.sceneElement(c.closest("li.item"));e.data.$layer.not(".selected").trigger(a.Event("selected",{item:e.item}));var f=_PANELS.properties.$element.find('input[data-prop="'+d+'"]');f.parentsUntil("ul.main").filter("li").addClass("open"),f.focus(),Danimator.time=c.data("time"),b.stopImmediatePropagation()}).on("dblclick","#animations-panel .track",function(b){var c=parseInt(prompt("Please enter a duration (in seconds) for this animation!","1s"));if(c&&!isNaN(c)){var d=a(this),e=d.closest("li.item").data("track").item,f=d.closest("li.timeline").data("property"),g=_.get(e,f);Danimator(e,f,g,g,c,{delay:Danimator.time}),_createTracks()}else alert("You have to supply a floating number for duration!","error")}).on("change","#properties-panel :input",function(){if(selectedElements.size){var b=a(this),c=b.data("prop"),d=b.closest("li").data(),e=b.data("oldValue")||this.defaultValue,f=b.is(":checkbox")?b.is(":checked"):b.val(),g=selectedElements.single.item,h=!1,i={};_["to"+_.capitalize(d.type)]&&(f=_["to"+_.capitalize(d.type)](f)),"number"===b.prop("type")&&(f=Number(f));var j=!!c.match(/^pivot\.?/),k=!!c.match(/^position\.?/);h=c.match(/^segments\.(\d+)\.(.*)/);var l=h?"change segment of "+_getAnimationName(g):"change property "+c+" of "+_getAnimationName(g,c);if(_changesFile("ani.json"),new Undoable(function(){h?(_.set(g.segments[parseInt(h[1])],h[2],f),_changesProp(h[2],f)):(i[c]=f,_.set(g,c,f),_changesProp(c,f),k&&(_changesProp("pivot.x",_.get(g.pivot,"x",g.bounds.center.x)),_changesProp("pivot.y",_.get(g.pivot,"y",g.bounds.center.y))),(j||k)&&(_anchorViz.position=g.pivot||g.bounds.center),c.match(/^state\.?/)&&(g.state=g.state))},function(){h?(_.set(g.segments[parseInt(h[1])],h[2],e),_changesProp(h[2],e)):(_.set(g,c,e),_changesProp(c,e),k&&(_changesProp("pivot.x",_.get(g.pivot,"x",g.bounds.center.x)),_changesProp("pivot.y",_.get(g.pivot,"y",g.bounds.center.y))),(j||k)&&(_anchorViz.position=g.pivot||g.bounds.center))},l),d.track){var m=selectedElements.single.item.id,n=tracks[m].properties[c];_.each(n,function(a,b){Danimator.time===_getStartTime(a)?(a.from=f,0===b&&(a.initValue=f)):Danimator.time===_getEndTime(a)&&(a.to=f)}),_createTracks()}b.data("oldValue",f)}}).on("keyup","#properties-panel :input",function(b){if(b.shiftKey){var c=0;switch(b.key){case"ArrowDown":c=-9;break;case"ArrowUp":c=9}if(0!==c){var d=a(this),e=parseFloat(d.attr("step")),f=[parseFloat(d.attr("min")),parseFloat(d.attr("max"))],g=parseFloat(d.val())+e*c;isNaN(f[0])&&(f[0]=-1e4),isNaN(f[1])&&(f[1]=1e4),d.val(_.round(Danimator.limit(g,f[0],f[1]),_decimalPlaces(10*e))).trigger("change")}}else if("Escape"===b.key){var d=a(this);d.val(d.attr("value")).blur()}}).on("mousewheel","#properties-panel :input",_.debounce(function(b){a(this).trigger("change")},600)).on("dblclick",".panel .audio",function(){a(this).data("wave").play()}).on("click",".panel .audio label",function(){var b=a(this).parent().toggleClass("muted");b.data("wave").setVolume(b.is(".muted")?0:100)}).on("mouseup",function(){_timeScrubbing&&Danimator._activeSound&&Danimator._activeSound.wave.pause(),_timeScrubbing=!1,_frameDragging=!1,b=-1,delete c,$animationValue.text("")}).on("keydown",function(b){if(!a(b.target).is(":input,[contenteditable]")){var c=0,d=0;switch(b.key){case"ArrowLeft":c=-1;break;case"ArrowRight":c=1;break;case"ArrowUp":d=-1;break;case"ArrowDown":d=1}if(c+d!==0){var e;(e=selectedElements.single)&&(b.shiftKey&&(c*=10,d*=10),e.item.position=e.item.position.add(new paper.Point(c,d)))}}}).on("keyup",function(b){if(!a(b.target).is(":input,[contenteditable]"))switch(b.key){case" ":var c=function(a){var b=(new Date).getTime()/1e3;_playing?Danimator.time>=Danimator.maxDuration?(currentGame.scene.item.off("frame",c),Danimator._activeSound.wave.stop(),Danimator.time=0,_playing=!1):Danimator.time=b-d:(currentGame.scene.item.off("frame",c),Danimator._activeSound.wave.pause())};return _playing?currentGame.scene.item.off("frame",c):(d=(new Date).getTime()/1e3-Danimator.time,currentGame.scene.item.on("frame",c),Danimator._activeSound.wave.play()),_playing=!_playing,!1;case"0":if(b.ctrlKey||b.metaKey)return currentGame.project.view.zoom=1.5,_anchorViz.scale(1),!1;break;case"o":selectedElements.size&&_PANELS.properties.$element.find("input[data-prop=opacity]").focus()[0].select();break;case"r":selectedElements.size&&_PANELS.properties.$element.find("input[data-prop=rotation]").focus()[0].select();break;case"s":(b.ctrlKey||b.metaKey)&&(currentGame.saveAll(b.shiftKey),b.preventDefault(),b.stopImmediatePropagation())}}).on("keypress",function(b){if(a(b.target).is(":input,[contenteditable]"))"Enter"===b.key&&a(b.target).trigger("blur");else{var c=b.ctrlKey||b.metaKey;switch(b.key){case",":return Danimator.time=Danimator.limit(Danimator.time-1/12,0,Danimator.maxDuration),!1;case".":return Danimator.time=Danimator.limit(Danimator.time+1/12,0,Danimator.maxDuration),!1;case";":return Danimator.time=Danimator.limit(Danimator.time-.5,0,Danimator.maxDuration),!1;case":":return Danimator.time=Danimator.limit(Danimator.time+.5,0,Danimator.maxDuration),!1;case"+":return currentGame.project.view.zoom+=.1,_anchorViz.scale(.9),!1;case"-":return currentGame.project.view.zoom-=.1,_anchorViz.scale(1.1),!1;case"z":return c&&history.back(),!1;case"y":return c&&history.forward(),!1}}}).on("mousewheel",function(a){if(a.metaKey){var b={x:a.originalEvent.deltaX,y:a.originalEvent.deltaY};if(Math.abs(b.x)>.1){var c=Danimator.time+1*b.x/24;a.shiftKey&&(c=_snapKeyframes.snap(c)),Danimator.time=c}a.preventDefault(),a.stopImmediatePropagation()}}).on("dragover","body",function(b){b.preventDefault(),b.stopImmediatePropagation(),a("#dummy").addClass("dropping")}).on("drop","#dummy",function(b){b.preventDefault();var c=new FormData;_.each(b.originalEvent.dataTransfer.items,function(a){console.log("item",a)}),_.each(b.originalEvent.dataTransfer.files,function(a,b){var d=a.type.split("/"),e=_.last(a.name.split(".")),f=new FileReader;f.onload=function(b){switch(currentGame.load(b.target.result),d[1]){case"javascript":console.log("script(s) on board.",e,a);break;case"svg+xml":console.log("vector on board.");break;default:console.error("not found!")}},"text"===d[0]?f.readAsText(a):f.readAsBinaryString(a),c.append("file_"+b,a)}),a("#dummy").removeClass("dropping")}).on("dragleave","#dummy",function(b){b.preventDefault(),b.stopImmediatePropagation(),a("#dummy").removeClass("dropping")})});var _throttledCreateAudio=_.debounce(_createAudio,100);Danimator.onSound=function(a,b){_throttledCreateAudio.apply(this,arguments)},Game.onLoad=function(a,b,c){var d=currentGame=this;d.time=0,d.saveAll=function(a){setLoading("saveAll"),_.each(currentGame.files,function(b,c){switch(c){case"ani.json":var d=_deepOmit(tracks,"item"),e=_basepath(currentGame.files.svg.path),f=_basename(currentGame.files.svg.path)+".ani.json";if(a){var g=JSON.stringify(d);a(new Blob([g],{type:"application/json;charset=utf-8"}),filename)
}else Danimator.save(d,e+f);b.saved=!0,delete d,delete g;break;case"svg":console.log("what about the SVG?")}}),alert("All saved!"),resetLoading("saveAll")},Danimator.onTimeChanged=function a(b){var c=_PANELS.properties.$element.find("li").removeClass("keyed");if($(".timeline .scrubber").each(function(){var a,d=$(this),e=Danimator.sceneElement(d.closest("li.item")),f=d.closest("li.timeline").data("property"),g=e.item.id;$time.text(_.round(b,2)+"s"),d.css("left",b*TIME_FACTOR);var h=tracks[g].properties[f];currentTracks=_.sortBy(_.filter(h,function(a){return a.options.delay<=b+_.get(a.options,"frameDuration",1/24)}),"options.delay"),_.each(currentTracks,function(c,d){if(_.inRange(b,_getStartTime(c),_getEndTime(c)+_.get(c.options,"frameDuration",1/24)))return a=c,a.id=d,!1});var i=d.closest(".track"),j=!1;if(i.find(".keyframe").removeClass("active"),a){var k=b-_getStartTime(a)<=.05,l=_getEndTime(a)-b<=0;k?i.find(".keyframe").eq(2*a.id).addClass("active"):l&&i.find(".keyframe").eq(2*a.id+1).addClass("active"),j=k||l}else a=_.maxBy(h,"options.delay");if(a){var m=_getStartTime(a),n=_getEndTime(a),o=Math.max((b-m)/(n-m),0);a.item=tracks[g].item,a.property=f,j&&selectedElements.has(e)&&c.find('input[data-prop="'+f+'"]').parent().addClass("keyed");var p,q=Danimator.step(a,o);p=_.isNumber(q.value)?_.round(q.value,2):'"'+q.value+'"',$currentTrack&&$currentTrack.length&&$.contains($currentTrack[0],d[0])&&$animationValue.text(f+" = "+p)}}),"onWaveSeek"!==a.caller.caller.name){var e=!!_timeScrubbing;_timeScrubbing=!0,_.each(Danimator.sounds,function(a){var c=_getEndTime(a)-_getStartTime(a);a.wave.seekTo(b/c)}),_timeScrubbing=e}d.time=b};var e,f,g=Danimator.layers=d.scene.item.children.slice(0).reverse(),h=($("#border-dummy"),function(){void 0!==e&&(e.remove(),e=void 0),paper.view.update()});return a.view.onMouseMove=function(b){var c=a.hitTest(b.point,{segments:!0,stroke:!0,curves:!0,fill:!0,guide:!1,tolerance:8/a.view.zoom});c?(c.item!==f&&h(),void 0===e&&!1===c.item.selected&&(e=_isBoundsItem(c.item)?new paper.Shape.Rectangle(c.item.bounds):c.item.clone(),"PointText"===c.item.className?e.set(_HOVER_STYLES.TEXT):e.set(_HOVER_STYLES.PATHS),e.strokeWidth&&(e.strokeWidth/=a.view.zoom),e.guide=!0,d.container.appendTop(e),f=c.item)):h()},paper.view.onMouseDown=function(a){if(a.event.altKey||a.event.metaKey)h();else{var b=Danimator.sceneElement(a.target);b?b.data.$layer.trigger($.Event("selected",{item:a.target,handpicked:!0})):_resetSelection()}},paper.view.onMouseDrag=function(a){if(0===a.event.button&&a.event.metaKey)if(selectedElements.size){var b=selectedElements.single.item;b.position=b.position.add(a.delta),_changesFile("ani.json"),b.pivot?(_changesProp("pivot.x",b.pivot.x),_changesProp("pivot.y",b.pivot.y),_anchorViz.position=b.pivot):_anchorViz.position=b.bounds.center,_changesProp("pivot.x",_anchorViz.position.x),_changesProp("pivot.y",_anchorViz.position.y),_changesProp("position.x",b.position.x),_changesProp("position.y",b.position.y)}else d.container.position=d.container.position.add(a.delta);a.event.preventDefault(),a.event.stopImmediatePropagation()},_anchorViz=new paper.Group([new paper.Path.Circle({center:a.view.center,radius:2,strokeWidth:2.5,strokeColor:"rgba(127,127,127,.4)",fillColor:"rgba(255,255,255,.4)"}),new paper.Path.Circle({center:a.view.center,radius:2,strokeColor:"cyan"}),new paper.Path.Line({from:a.view.center.subtract(new paper.Point(0,2)),to:a.view.center.subtract(new paper.Point(0,4)),strokeColor:"cyan"}),new paper.Path.Line({from:a.view.center.add(new paper.Point(0,2)),to:a.view.center.add(new paper.Point(0,4)),strokeColor:"cyan"}),new paper.Path.Line({from:a.view.center.subtract(new paper.Point(2,0)),to:a.view.center.subtract(new paper.Point(4,0)),strokeColor:"cyan"}),new paper.Path.Line({from:a.view.center.add(new paper.Point(2,0)),to:a.view.center.add(new paper.Point(4,0)),strokeColor:"cyan"})]),_anchorViz.visible=!1,_anchorViz.onMouseDown=function(a){a.event.altKey&&(this.data.oldPosition=a.point)},_anchorViz.onMouseDrag=function(a){a.event.altKey&&(this.position=a.point,selectedElements.single.item.pivot=this.position,_changesProp("pivot.x",this.position.x),_changesProp("pivot.y",this.position.y))},_anchorViz.onMouseUp=function(a){var b=this,c=selectedElements.single.item;a.event.altKey&&new Undoable(function(){b.position=a.point,c.pivot=b.position},function(){b.data.oldPosition&&(b.position=b.data.oldPosition,c.pivot=b.position)},"setting pivot of "+_getAnimationName(c),!0)},d.container.appendTop(_anchorViz),_createLayers(g,_PANELS.layers.$element.find("ul").empty()),Danimator.sound||_PANELS.audio.$element.hide(),$("body").addClass("ready"),this};